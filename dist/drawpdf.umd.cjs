(function(S,F){typeof exports=="object"&&typeof module<"u"?F(exports,require("jspdf"),require("jspdf-autotable")):typeof define=="function"&&define.amd?define(["exports","jspdf","jspdf-autotable"],F):(S=typeof globalThis<"u"?globalThis:S||self,F(S.DrawPDF={},S.jspdf))})(this,function(S,F){"use strict";class H{constructor(){this.inlineTags=["b","strong","i","em","u","s","strike","span"]}tokenize(t){if(!t||typeof t!="string")return[{text:"",style:this.createDefaultStyle()}];const i=document.createElement("div");i.innerHTML=t;const e=[];return this.walkTree(i,this.createDefaultStyle(),e),this.mergeSegments(e)}createDefaultStyle(){return{bold:!1,italic:!1,underline:!1,strikethrough:!1,color:null,backgroundColor:null,fontSize:null}}decodeHtmlEntities(t){if(!t||typeof t!="string")return t;const i={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&apos;":"'","&ndash;":"–","&mdash;":"—","&hellip;":"…","&copy;":"©","&reg;":"®","&trade;":"™","&deg;":"°","&plusmn;":"±","&times;":"×","&divide;":"÷"};let e=t;for(const[r,s]of Object.entries(i))e=e.split(r).join(s);return e=e.replace(/&#(\d+);/g,(r,s)=>String.fromCharCode(s)),e=e.replace(/&#x([0-9a-fA-F]+);/g,(r,s)=>String.fromCharCode(parseInt(s,16))),e=e.replace(/\u00A0/g," "),e}walkTree(t,i,e){const r=t.childNodes;for(let s=0;s<r.length;s++){const n=r[s];if(n.nodeType===Node.TEXT_NODE){let o=n.textContent;o=this.decodeHtmlEntities(o),o&&e.push({text:o,style:{...i}})}else if(n.nodeType===Node.ELEMENT_NODE){const o=this.applyNodeStyle(n,i);this.walkTree(n,o,e)}}}applyNodeStyle(t,i){const e={...i};switch(t.tagName.toLowerCase()){case"b":case"strong":e.bold=!0;break;case"i":case"em":e.italic=!0;break;case"u":e.underline=!0;break;case"s":case"strike":case"del":e.strikethrough=!0;break}return t.style&&((t.style.fontWeight==="bold"||parseInt(t.style.fontWeight)>=700)&&(e.bold=!0),t.style.fontStyle==="italic"&&(e.italic=!0),t.style.textDecoration&&(t.style.textDecoration.includes("underline")&&(e.underline=!0),t.style.textDecoration.includes("line-through")&&(e.strikethrough=!0)),t.style.color&&(e.color=this.parseColor(t.style.color)),t.style.backgroundColor&&(e.backgroundColor=this.parseColor(t.style.backgroundColor)),t.style.fontSize&&(e.fontSize=this.parseFontSize(t.style.fontSize))),e}parseColor(t){if(!t)return null;if(t.startsWith("#"))return t;const i=t.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);if(i){const r=parseInt(i[1]),s=parseInt(i[2]),n=parseInt(i[3]);return[r,s,n]}const e=t.match(/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*[\d.]+\s*\)/i);if(e){const r=parseInt(e[1]),s=parseInt(e[2]),n=parseInt(e[3]);return[r,s,n]}return null}parseFontSize(t){if(!t)return null;const i=t.match(/(\d+(?:\.\d+)?)\s*px/i);if(i)return Math.round(parseFloat(i[1])*.75);const e=t.match(/(\d+(?:\.\d+)?)\s*pt/i);if(e)return parseFloat(e[1]);const r=t.match(/^(\d+(?:\.\d+)?)$/);return r?parseFloat(r[1]):null}mergeSegments(t){if(t.length===0)return t;const i=[];let e={...t[0]};for(let r=1;r<t.length;r++){const s=t[r];this.stylesEqual(e.style,s.style)?e.text+=s.text:(e.text&&i.push(e),e={...s})}return e.text&&i.push(e),i}stylesEqual(t,i){return t.bold===i.bold&&t.italic===i.italic&&t.underline===i.underline&&t.strikethrough===i.strikethrough&&this.colorsEqual(t.color,i.color)&&t.fontSize===i.fontSize}colorsEqual(t,i){return t===i?!0:!t||!i?!1:Array.isArray(t)&&Array.isArray(i)?t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]:!1}}const _={WIDTH:210,HEIGHT:297,MARGIN_TOP:20,MARGIN_BOTTOM:20,MARGIN_LEFT:15,MARGIN_RIGHT:15,get CONTENT_WIDTH(){return this.WIDTH-this.MARGIN_LEFT-this.MARGIN_RIGHT},get CONTENT_HEIGHT(){return this.HEIGHT-this.MARGIN_TOP-this.MARGIN_BOTTOM}},x={DEFAULT_SIZE:12,LINE_HEIGHT:1.5,H1_SIZE:18,H2_SIZE:16,H3_SIZE:14};class I{constructor(){this.currentY=_.MARGIN_TOP,this.currentPage=0,this.pages=[{pageNumber:1,elements:[]}],this.tokenizer=new H}decodeHtmlEntities(t){if(!t||typeof t!="string")return t;const i={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&apos;":"'","&ndash;":"–","&mdash;":"—","&hellip;":"…"};let e=t;for(const[r,s]of Object.entries(i))e=e.split(r).join(s);return e=e.replace(/&#(\d+);/g,(r,s)=>String.fromCharCode(s)),e=e.replace(/&#x([0-9a-fA-F]+);/g,(r,s)=>String.fromCharCode(parseInt(s,16))),e=e.replace(/\u00A0/g," "),e}parse(t){this.currentY=_.MARGIN_TOP,this.currentPage=0,this.pages=[{pageNumber:1,elements:[]}];const r=new DOMParser().parseFromString(t,"text/html").body.children;for(let s=0;s<r.length;s++)this.processNode(r[s]);return{version:"1.0",pageSize:{width:_.WIDTH,height:_.HEIGHT,unit:"mm"},margins:{top:_.MARGIN_TOP,bottom:_.MARGIN_BOTTOM,left:_.MARGIN_LEFT,right:_.MARGIN_RIGHT},pages:this.pages}}processNode(t){var e,r;switch((e=t.tagName)==null?void 0:e.toLowerCase()){case"p":this.processParagraph(t);break;case"h1":this.processHeading(t,1);break;case"h2":this.processHeading(t,2);break;case"h3":this.processHeading(t,3);break;case"ul":this.processList(t,"bullet");break;case"ol":this.processList(t,"number");break;case"table":this.processTable(t);break;case"figure":t.querySelector("table")?this.processTable(t.querySelector("table")):t.querySelector("img")&&this.processImage(t.querySelector("img"));break;case"hr":this.processHorizontalRule();break;case"pre":this.processCodeBlock(t);break;default:(r=t.textContent)!=null&&r.trim()&&this.addTextElement(t.textContent.trim(),{})}}processParagraph(t){const i=t.innerHTML,e=this.extractStyles(t),r=t.style.textAlign||"left";this.addTextElement(i,{...e,align:r})}processHeading(t,i){const e=t.innerHTML,r={1:x.H1_SIZE,2:x.H2_SIZE,3:x.H3_SIZE};this.addTextElement(e,{fontSize:r[i],fontWeight:"bold",align:t.style.textAlign||"left"})}processList(t,i){t.querySelectorAll("li").forEach((r,s)=>{const o=(i==="number"?`${s+1}. `:"• ")+r.innerHTML;this.addTextElement(o,{indent:10})})}processTable(t){const i=[],e=t.querySelectorAll("tr"),r={width:this.parseWidth(t.style.width||t.getAttribute("width")),borderWidth:this.parseBorderWidth(t.style.border||t.getAttribute("border")),borderColor:this.parseColor(t.style.borderColor)||"#000000",backgroundColor:this.parseColor(t.style.backgroundColor),align:this.parseTableAlign(t)};e.forEach(s=>{const n=[];s.querySelectorAll("td, th").forEach(a=>{const l=a.querySelector("img"),c=parseInt(a.getAttribute("colspan"))||1,d=parseInt(a.getAttribute("rowspan"))||1;let h=a.style.textAlign||"left";const g=a.querySelector('p[style*="text-align"]');g&&g.style.textAlign&&(h=g.style.textAlign);const u={backgroundColor:this.parseColor(a.style.backgroundColor),borderColor:this.parseColor(a.style.borderColor),borderWidth:this.parseBorderWidth(a.style.border||a.style.borderWidth),verticalAlign:a.style.verticalAlign||"middle",padding:this.parsePadding(a.style.padding),width:this.parseWidth(a.style.width||a.getAttribute("width")),height:this.parseWidth(a.style.height||a.getAttribute("height"))};l?n.push({type:"image",src:l.src||l.getAttribute("src"),width:parseInt(l.width)||50,height:parseInt(l.height)||50,colSpan:c,rowSpan:d,align:h,isHeader:a.tagName.toLowerCase()==="th",cellStyle:u}):n.push({content:a.innerHTML||" ",isHeader:a.tagName.toLowerCase()==="th",colSpan:c,rowSpan:d,align:h,cellStyle:u})}),i.push(n)}),this.addElement({type:"table",width:r.width||_.CONTENT_WIDTH,rows:i,style:r})}parseWidth(t){if(!t)return null;const i=parseFloat(t);return isNaN(i)?null:String(t).includes("%")?i/100*_.CONTENT_WIDTH:String(t).includes("px")?i*.264:i}parseBorderWidth(t){if(!t)return .5;const i=String(t).match(/(\d+\.?\d*)/);if(i){const e=parseFloat(i[1]);return e>5?e*.264:e}return .5}parseColor(t){if(!t)return null;if(t.startsWith("#"))return t;const i=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(i){const e=parseInt(i[1]).toString(16).padStart(2,"0"),r=parseInt(i[2]).toString(16).padStart(2,"0"),s=parseInt(i[3]).toString(16).padStart(2,"0");return`#${e}${r}${s}`}return t}parseTableAlign(t){const i=t.style.marginLeft,e=t.style.marginRight;return i==="auto"&&e==="auto"?"center":i==="auto"?"right":"left"}parsePadding(t){if(!t)return null;const i=parseFloat(t);return isNaN(i)?null:i*.264}processImage(t){const i=t.src||t.getAttribute("src"),e=parseInt(t.width)||50,r=parseInt(t.height)||50,s=Math.min(e*.264,_.CONTENT_WIDTH),n=r*.264;this.addElement({type:"image",width:s,height:n,src:i,align:"left"})}processHorizontalRule(){this.addElement({type:"line",fullWidth:!0,style:{color:"#cccccc",width:.5}})}extractStyles(t){var l,c,d,h;const i={},e=t.innerHTML;(e.includes("<strong>")||e.includes("<b>")||t.style.fontWeight==="bold")&&(i.fontWeight="bold"),(e.includes("<i>")||e.includes("<em>")||t.style.fontStyle==="italic")&&(i.fontStyle="italic"),(e.includes("<u>")||(l=t.style.textDecoration)!=null&&l.includes("underline"))&&(i.underline=!0);const r=e.match(/color:\s*([^;"]+)/);r&&(i.color=r[1]);const s=e.match(/font-size:\s*(\d+)/);s&&(i.fontSize=parseInt(s[1]));const n=(c=t.style.marginLeft)==null?void 0:c.match(/(\d+)/);n&&(i.marginLeft=parseFloat(n[1])*.264);const o=(d=t.style.textIndent)==null?void 0:d.match(/(\d+)/);o&&(i.indent=parseFloat(o[1])*.264);const a=(h=t.style.paddingLeft)==null?void 0:h.match(/(\d+)/);return a&&(i.indent=(i.indent||0)+parseFloat(a[1])*.264),i}addTextElement(t,i){const e=this.tokenizer.tokenize(t),r=e.map(l=>l.text).join("");if(!r.trim()){this.addElement({type:"space",height:(i.fontSize||x.DEFAULT_SIZE)*x.LINE_HEIGHT*.352778});return}const s=i.fontSize||x.DEFAULT_SIZE,n=s*x.LINE_HEIGHT*.352778,o=(i.indent||0)+(i.marginLeft||0),a=_.CONTENT_WIDTH-o;this.addElement({type:"richtext",indent:i.indent||0,marginLeft:i.marginLeft||0,width:a,segments:e,content:r,style:{fontSize:s,fontWeight:i.fontWeight||"normal",fontStyle:i.fontStyle||"normal",color:i.color||"#000000",align:i.align||"left",underline:i.underline||!1,lineHeight:n}})}addElement(t){this.pages[this.currentPage].elements.push(t)}newPage(){this.currentPage++,this.pages.push({pageNumber:this.currentPage+1,elements:[]}),this.currentY=_.MARGIN_TOP}processCodeBlock(t){const i=t.querySelector("code")||t;let e=i.textContent||"";e=this.decodeHtmlEntities(e);const r=e.trim().startsWith("// eval")||e.trim().startsWith("/* eval */")||e.trim().startsWith("//eval"),n=(i.className||"").match(/language-(\w+)/),o=n?n[1]:"javascript",a={type:r?"evalblock":"codeblock",code:e.trim(),language:o,isEval:r};this.addElement(a),console.log("[CKEditorParser] Code block:",r?"EVAL":"DISPLAY",o)}}class C{static getNestedValue(t,i){if(!t||!i)return;const e=i.trim().split(".");let r=t;for(const s of e){if(r==null)return;r=r[s]}return r}static evaluateCondition(t,i){const e=t.trim(),r=["===","!==",">=","<=",">","<"];for(const n of r)if(e.includes(n)){const[o,a]=e.split(n).map(d=>d.trim()),l=this.resolveValue(o,i),c=this.resolveValue(a,i);switch(n){case"===":return l===c;case"!==":return l!==c;case">":return l>c;case"<":return l<c;case">=":return l>=c;case"<=":return l<=c}}return!!this.resolveValue(e,i)}static resolveValue(t,i){const e=t.trim();if(e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"'))return e.slice(1,-1);if(!isNaN(e)&&e!=="")return parseFloat(e);if(e==="true")return!0;if(e==="false")return!1;if(e==="null")return null;if(e!=="undefined")return this.getNestedValue(i,e)}static processIfBlocks(t,i){const e=/\{\{#if\s+([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g;return t.replace(e,(r,s,n)=>{const o=this.evaluateCondition(s,i),a=n.indexOf("{{else}}");if(a!==-1){const l=n.substring(0,a),c=n.substring(a+8);return o?l:c}return o?n:""})}static processEachBlocks(t,i){const e=/\{\{~?#each\s+([^}~]+)~?\}\}([\s\S]*?)\{\{~?\/each~?\}\}/g;return t.replace(e,(r,s,n)=>{const o=s.trim(),a=this.getNestedValue(i,o);if(console.log("[TemplateEngine] #each:",o,"array:",a),!Array.isArray(a)||a.length===0)return console.log("[TemplateEngine] #each: array not found or empty"),"";const l=n.trim();return a.map((c,d)=>{const h={...i,...c,"@index":d,"@first":d===0,"@last":d===a.length-1,"@item":c};let g=this.processIfBlocks(l,h);return g=this.processFormatHelpers(g,h),g=this.processDateHelpers(g),g=this.replaceVariables(g,h),g=this.processLayoutTags(g),g.trim()}).join(`
`)})}static processLayoutTags(t){let i=t;return i=i.replace(/\{\{br\}\}/gi,"___BR___"),i=i.replace(/\{\{tab\}\}/gi,"___TAB___"),i=i.replace(/\{\{space\}\}/gi," "),i=i.replace(/\{\{hr\}\}/gi,"___HR___"),i=i.replace(/\{\{pageBreak\}\}/gi,"___PAGEBREAK___"),i}static processFormatHelpers(t,i){let e=t;return e=e.replace(/\{\{formatNumber\s+([^}]+)\}\}/g,(r,s)=>{const n=this.getNestedValue(i,s.trim());return n==null?r:this.formatNumber(n)}),e=e.replace(/\{\{formatCurrency\s+([^}]+)\}\}/g,(r,s)=>{const n=this.getNestedValue(i,s.trim());return n==null?r:this.formatCurrency(n)}),e=e.replace(/\{\{formatDate\s+([^}]+)\}\}/g,(r,s)=>{const n=this.getNestedValue(i,s.trim());return n==null?r:this.formatDate(n)}),e=e.replace(/\{\{uppercase\s+([^}]+)\}\}/g,(r,s)=>{const n=this.getNestedValue(i,s.trim());return n==null?r:String(n).toUpperCase()}),e=e.replace(/\{\{lowercase\s+([^}]+)\}\}/g,(r,s)=>{const n=this.getNestedValue(i,s.trim());return n==null?r:String(n).toLowerCase()}),e=e.replace(/\{\{capitalize\s+([^}]+)\}\}/g,(r,s)=>{const n=this.getNestedValue(i,s.trim());return n==null?r:String(n).replace(/\b\w/g,o=>o.toUpperCase())}),e}static processDateHelpers(t){const i=new Date;let e=t;return e=e.replace(/\{\{now\}\}/gi,i.toLocaleString("vi-VN")),e=e.replace(/\{\{today\}\}/gi,this.formatDateObject(i)),e=e.replace(/\{\{year\}\}/gi,String(i.getFullYear())),e=e.replace(/\{\{month\}\}/gi,String(i.getMonth()+1).padStart(2,"0")),e=e.replace(/\{\{day\}\}/gi,String(i.getDate()).padStart(2,"0")),e=e.replace(/\{\{time\}\}/gi,`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}`),e}static formatNumber(t){const i=parseFloat(t);return isNaN(i)?String(t):i.toLocaleString("vi-VN")}static formatCurrency(t){const i=parseFloat(t);return isNaN(i)?String(t):i.toLocaleString("vi-VN")+"đ"}static formatDate(t){if(!t)return"";if(typeof t=="string"&&/^\d{2}\/\d{2}\/\d{4}$/.test(t))return t;const i=new Date(t);return isNaN(i.getTime())?String(t):this.formatDateObject(i)}static formatDateObject(t){const i=String(t.getDate()).padStart(2,"0"),e=String(t.getMonth()+1).padStart(2,"0"),r=t.getFullYear();return`${i}/${e}/${r}`}static replaceVariables(t,i){return!t||typeof t!="string"?t||"":t.replace(/\{\{([^#\/][^}]*?)\}\}/g,(e,r)=>{const s=r.trim();if(["br","tab","space","hr","pageBreak","now","today","year","month","day","time"].includes(s.toLowerCase())||s.startsWith("formatNumber")||s.startsWith("formatCurrency")||s.startsWith("formatDate")||s.startsWith("uppercase")||s.startsWith("lowercase")||s.startsWith("capitalize"))return e;if(s.startsWith("@")){const a=i[s];return a!==void 0?String(a):e}const o=this.getNestedValue(i,s);return o!==void 0?String(o):e})}static process(t,i){if(!t||typeof t!="string")return t||"";let e=t;return e=this.processIfBlocks(e,i),e=this.processEachBlocks(e,i),e=this.processFormatHelpers(e,i),e=this.processDateHelpers(e),e=this.replaceVariables(e,i),e=this.processLayoutTags(e),e}static extractVariables(t){if(!t||typeof t!="string")return[];const i=new Set,e=["br","tab","space","hr","pageBreak","now","today","year","month","day","time","else"],r=/\{\{([^#\/][^}]*?)\}\}/g;let s;for(;(s=r.exec(t))!==null;){const a=s[1].trim();if(!a.startsWith("@")&&!e.includes(a.toLowerCase())){if(a.startsWith("formatNumber ")||a.startsWith("formatCurrency ")||a.startsWith("formatDate ")||a.startsWith("uppercase ")||a.startsWith("lowercase ")||a.startsWith("capitalize ")){const l=a.split(" ");l[1]&&i.add(l[1].trim());continue}i.add(a)}}const n=/\{\{#each\s+([^}]+)\}\}/g;for(;(s=n.exec(t))!==null;)i.add(s[1].trim());const o=/\{\{#if\s+([^}]+)\}\}/g;for(;(s=o.exec(t))!==null;)s[1].trim().split(/[=!<>]+/).map(c=>c.trim()).forEach(c=>{c&&!c.startsWith("'")&&!c.startsWith('"')&&isNaN(c)&&c!=="true"&&c!=="false"&&c!=="null"&&i.add(c)});return Array.from(i)}}class v{constructor(){this.doc=new F.jsPDF,this.currentY=20,this.lineHeight=1,this.pageHeight=this.doc.internal.pageSize.height,this.pageWidth=this.doc.internal.pageSize.width,this.margins={left:15,right:15,top:20,bottom:20},this.setupVietnameseFont()}setupVietnameseFont(){try{this.doc.getFontList().Roboto?this.doc.setFont("Roboto","normal"):this.doc.setFont("helvetica","normal")}catch(t){console.warn("Không thể load font Roboto, sử dụng font mặc định:",t.message),this.doc.setFont("helvetica","normal")}}checkPageBreak(t=10){this.currentY+t>this.pageHeight-this.margins.bottom&&this.addNewPage()}_decodeHtmlEntities(t){if(!t||typeof t!="string")return t;let i=t.replace(/\u00A0/g," ");const e={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&apos;":"'","&ndash;":"–","&mdash;":"—","&hellip;":"…","&copy;":"©","&reg;":"®","&trade;":"™","&deg;":"°","&plusmn;":"±","&times;":"×","&divide;":"÷","&cent;":"¢","&pound;":"£","&euro;":"€","&yen;":"¥","&sect;":"§","&bull;":"•"};for(const[r,s]of Object.entries(e))i=i.split(r).join(s);return i=i.replace(/&#(\d+);/g,(r,s)=>{const n=parseInt(s,10);return n===160?" ":String.fromCharCode(n)}),i=i.replace(/&#x([0-9a-fA-F]+);/g,(r,s)=>{const n=parseInt(s,16);return n===160?" ":String.fromCharCode(n)}),i=i.replace(/\u00A0/g," "),i}_drawText(t,i,e,r={}){const s=this._decodeHtmlEntities(t);this.doc.text(s,i,e,r)}_parseColorToArray(t){if(Array.isArray(t))return t;if(!t)return[0,0,0];if(typeof t=="string"&&t.startsWith("#")){let i=t.slice(1);i.length===3&&(i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]);const e=parseInt(i.substring(0,2),16)||0,r=parseInt(i.substring(2,4),16)||0,s=parseInt(i.substring(4,6),16)||0;return[e,r,s]}if(typeof t=="string"){const i=t.match(/rgb[a]?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(i)return[parseInt(i[1]),parseInt(i[2]),parseInt(i[3])]}return[0,0,0]}addText(t,i=null,e=null,r={}){t=this._decodeHtmlEntities(t);const n={...{fontSize:12,fontStyle:"normal",color:[0,0,0],maxWidth:this.pageWidth-this.margins.left-this.margins.right,align:"left",lineHeight:this.lineHeight},...r},o=i!==null?i:this.margins.left;e!==null||this.currentY,this.doc.setFontSize(n.fontSize);try{this.doc.setFont("Roboto",n.fontStyle)}catch{this.doc.setFont("helvetica",n.fontStyle)}this.doc.setTextColor(n.color[0],n.color[1],n.color[2]);const a=this.doc.splitTextToSize(t,n.maxWidth),l=a.length*n.lineHeight;this.checkPageBreak(l+5);let c=this.currentY;a.forEach((h,g)=>{if(n.align==="center"){const u=this.doc.getTextWidth(h),f=(this.pageWidth-u)/2;this._drawText(h,f,c)}else if(n.align==="right"){const u=this.doc.getTextWidth(h),f=this.pageWidth-this.margins.right-u;this._drawText(h,f,c)}else n.align==="justify"?!(g===a.length-1)&&h.trim().length>0?this.drawJustifiedText(h,o,c,n.maxWidth,n):this._drawText(h,o,c):this._drawText(h,o,c);c+=n.lineHeight});const d=r.spacing!==void 0?r.spacing:1;return this.currentY=c+d,this}drawJustifiedText(t,i,e,r,s){const n=t.trim().split(" ");if(n.length<=1){this._drawText(t,i,e);return}let o=0;n.forEach(h=>{o+=this.doc.getTextWidth(h)});const a=n.length-1,c=(r-o)/a;let d=i;n.forEach((h,g)=>{this._drawText(h,d,e),d+=this.doc.getTextWidth(h),g<n.length-1&&(d+=c)})}addTable(t,i,e={}){if(!this.doc.autoTable)return console.warn("jspdf-autotable is not loaded"),this;const r=e.y!==void 0?e.y:this.currentY,s={font:"Roboto",fontSize:10,cellPadding:3,overflow:"linebreak"};e.lineWidth!==void 0&&(s.lineWidth=e.lineWidth),e.lineColor&&(s.lineColor=e.lineColor),e.fillColor&&(s.fillColor=e.fillColor);let n={top:this.margins.top,right:this.margins.right,bottom:this.margins.bottom,left:this.margins.left},o=e.tableWidth||"auto";if(e.tableAlign==="center"&&e.tableWidth){const d=(this.pageWidth-this.margins.left-this.margins.right-e.tableWidth)/2;n.left=this.margins.left+d}else if(e.tableAlign==="right"&&e.tableWidth){const d=this.pageWidth-this.margins.left-this.margins.right-e.tableWidth;n.left=this.margins.left+d}const a={fillColor:!1,textColor:[0,0,0],halign:"center",...e.headStyles||{}},l={startY:r,head:[t],body:i,theme:"grid",styles:s,headStyles:a,columnStyles:{},margin:n,tableWidth:typeof o=="number"?o:"auto",didDrawPage:c=>{this.currentY=c.cursor.y+5},...e};return this.doc.autoTable(l),this.doc.lastAutoTable&&(this.currentY=this.doc.lastAutoTable.finalY+10),this}addTitle(t,i={}){const e={fontSize:18,fontStyle:"bold",color:[0,0,0],align:"center",lineHeight:7,...i};return this.addText(t,null,null,e),this.currentY+=3,this}addSubTitle(t,i={}){const e={fontSize:14,fontStyle:"bold",color:[0,0,0],lineHeight:5.5,...i};return this.addText(t,null,null,e),this.currentY+=2,this}addParagraph(t,i={}){const e={fontSize:10,fontStyle:"normal",color:[0,0,0],lineHeight:4,spacing:1,...i};return this.addText(t,null,null,e),this}addBulletPoint(t,i={}){const e={fontSize:11,fontStyle:"normal",color:[0,0,0],lineHeight:4,...i};this.doc.setFontSize(e.fontSize),this._drawText("•",this.margins.left,this.currentY);const r=t,s={...e,maxWidth:e.maxWidth-10};return this.addText(r,this.margins.left+8,this.currentY,s),this}addImage(t,i=null,e=null,r=100,s=100,n={}){const o={format:"JPEG",align:"left",caption:null,captionOptions:{fontSize:9,fontStyle:"italic",color:[100,100,100]},border:!1,borderOptions:{width:1,color:[0,0,0]},compression:"MEDIUM",rotation:0,...n};let a=i!==null?i:this.margins.left;e!==null||this.currentY,o.align==="center"?a=(this.pageWidth-r)/2:o.align==="right"&&(a=this.pageWidth-this.margins.right-r),this.checkPageBreak(s+15);try{let l=o.format;if(typeof t=="string"&&t.startsWith("data:")&&(t.includes("data:image/png")?l="PNG":t.includes("data:image/jpeg")||t.includes("data:image/jpg")?l="JPEG":t.includes("data:image/gif")?l="GIF":t.includes("data:image/webp")&&(l="WEBP")),this.doc.addImage(t,l,a,this.currentY,r,s,"",o.compression,o.rotation),o.border){this.doc.setLineWidth(o.borderOptions.width);const c=Array.isArray(o.borderOptions.color)?o.borderOptions.color:[0,0,0];this.doc.setDrawColor(...c),this.doc.rect(a,this.currentY,r,s)}this.currentY+=s+5,o.caption?this.addText(o.caption,null,null,{...o.captionOptions,align:o.align}):this.currentY+=5}catch(l){console.error("Lỗi khi thêm ảnh:",l),this.addText(`[Lỗi hiển thị ảnh: ${l.message}]`,a,null,{fontSize:10,color:[255,0,0],align:o.align})}return this}async addImageFromPath(t,i=null,e=null,r=100,s=100,n={}){try{const o=await this.loadImageFromPath(t);if(o)return this.addImage(o,i,e,r,s,n);throw new Error(`Không thể load ảnh từ ${t}`)}catch(o){console.error("Lỗi khi thêm ảnh từ path:",o),this.addText(`[Không thể load ảnh: ${t}]`,i,e,{fontSize:10,color:[255,0,0]})}return this}addImageFit(t,i=null,e=null,r=150,s=150,n={}){return new Promise(o=>{const a=new Image;a.onload=()=>{let{width:l,height:c}=this.calculateFitSize(a.naturalWidth,a.naturalHeight,r,s);this.addImage(t,i,e,l,c,n),o(this)},a.onerror=()=>{console.error("Không thể load ảnh để tính kích thước"),this.addImage(t,i,e,r,s,n),o(this)},a.src=t})}calculateFitSize(t,i,e,r){const s=e/t,n=r/i,o=Math.min(s,n);return{width:t*o,height:i*o}}addLine(t=null,i=null,e=null,r=null,s={}){const n=t!==null?t:this.margins.left,o=i!==null?i:this.currentY,a=e!==null?e:this.pageWidth-this.margins.right,l=r!==null?r:o,c={lineWidth:.5,color:[0,0,0],...s};return this.doc.setLineWidth(c.lineWidth),this.doc.setDrawColor(c.color[0],c.color[1],c.color[2]),this.doc.line(n,o,a,l),this.currentY=o+8,this}addNewPage(){return this.doc.addPage(),this.currentY=this.margins.top,this._addSecondarySignaturesToNewPage(),this}addSpace(t=10){return this.currentY+=t,this.checkPageBreak(),this}addHorizontalLine(t={}){const i={width:t.width||this.pageWidth-this.margins.left-this.margins.right,thickness:t.thickness||.5,color:t.color||[0,0,0],marginTop:t.marginTop||3,marginBottom:t.marginBottom||3,...t};this.currentY+=i.marginTop,this.checkPageBreak(i.thickness+i.marginBottom);const e=this.margins.left,r=e+i.width;return this.doc.setDrawColor(...i.color),this.doc.setLineWidth(i.thickness),this.doc.line(e,this.currentY,r,this.currentY),this.currentY+=i.thickness+i.marginBottom,this}resetPosition(t=null){return this.currentY=t!==null?t:this.margins.top,this}getCurrentY(){return this.currentY}addHeader(t,i={}){const e={fontSize:10,fontStyle:"normal",align:"center",color:[0,0,0],y:10,...i},r=this.doc.internal.getNumberOfPages(),s=this.doc.internal.getCurrentPageInfo().pageNumber,n=this.doc.internal.getCurrentPageInfo().color||[0,0,0];for(let o=1;o<=r;o++){this.doc.setPage(o),this.doc.setFontSize(e.fontSize),this.doc.setTextColor(e.color[0],e.color[1],e.color[2]);try{this.doc.setFont("Roboto",e.fontStyle)}catch{this.doc.setFont("helvetica",e.fontStyle)}let a;const l=this.doc.getTextWidth(t);e.align==="center"?a=(this.pageWidth-l)/2:e.align==="right"?a=this.pageWidth-this.margins.right-l:a=this.margins.left,this._drawText(t,a,e.y)}return this.doc.setTextColor(n[0]||0,n[1]||0,n[2]||0),this.doc.setPage(s),this}addFooter(t,i={}){const e={fontSize:8,fontStyle:"normal",align:"center",y:this.pageHeight-10,color:[0,0,0],...i},r=this.doc.internal.getNumberOfPages(),s=this.doc.internal.getCurrentPageInfo().pageNumber;for(let n=1;n<=r;n++){this.doc.setPage(n),this.doc.setFontSize(e.fontSize);try{this.doc.setFont("Roboto",e.fontStyle)}catch{this.doc.setFont("helvetica",e.fontStyle)}const o=Array.isArray(e.color)?e.color:[0,0,0];this.doc.setTextColor(o[0],o[1],o[2]);const a=t.replace("{pageNumber}",n).replace("{totalPages}",r);if(e.align==="center"){const l=this.doc.getTextWidth(a),c=(this.pageWidth-l)/2;this._drawText(a,c,e.y)}else if(e.align==="right"){const l=this.doc.getTextWidth(a);this._drawText(a,this.pageWidth-this.margins.right-l,e.y)}else this._drawText(a,this.margins.left,e.y)}return this.doc.setPage(s),this}savePDF(t="document.pdf"){try{this.doc.save(t),console.log(`PDF đã được lưu: ${t}`)}catch(i){console.error("Lỗi khi lưu PDF:",i)}}generateBlob(){try{return this.doc.output("blob")}catch(t){return console.error("Lỗi khi tạo blob:",t),null}}generateDataURL(){try{return this.doc.output("dataurlstring")}catch(t){return console.error("Lỗi khi tạo data URL:",t),null}}previewPDF(){try{const t=this.doc.output("dataurlstring");window.open(t,"_blank")}catch(t){console.error("Lỗi khi preview PDF:",t)}}exportPDFFile(t="document.pdf"){try{const i=this.doc.output("blob"),e=new File([i],t,{type:"application/pdf",lastModified:Date.now()});return console.log(`PDF file đã được tạo: ${t}, Size: ${e.size} bytes`),e}catch(i){return console.error("Lỗi khi tạo PDF file:",i),null}}exportPDFArrayBuffer(){try{const t=this.doc.output("arraybuffer");return console.log(`PDF ArrayBuffer đã được tạo, Size: ${t.byteLength} bytes`),t}catch(t){return console.error("Lỗi khi tạo PDF ArrayBuffer:",t),null}}exportPDF(t="file",i="document.pdf"){try{switch(t.toLowerCase()){case"file":return this.exportPDFFile(i);case"blob":return this.generateBlob();case"arraybuffer":return this.exportPDFArrayBuffer();case"dataurl":return this.generateDataURL();case"base64":return this.doc.output("datauristring").split(",")[1];case"binarystring":return this.doc.output("binarystring");default:return console.warn(`Format không hỗ trợ: ${t}. Sử dụng format 'file' mặc định.`),this.exportPDFFile(i)}}catch(e){return console.error(`Lỗi khi export PDF với format ${t}:`,e),null}}async uploadPDFToServer(t,i="document.pdf",e={}){try{const r=this.exportPDFFile(i);if(!r)throw new Error("Không thể tạo PDF file");const s=new FormData;s.append(e.fieldName||"pdf",r),e.additionalData&&Object.keys(e.additionalData).forEach(l=>{s.append(l,e.additionalData[l])});const n={method:"POST",body:s,...e.fetchOptions};console.log(`Đang upload PDF tới: ${t}`);const o=await fetch(t,n);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=await o.json();return console.log("Upload thành công:",a),a}catch(r){throw console.error("Lỗi khi upload PDF:",r),r}}addSignature(t,i,e=null,r={}){const s={align:"right",fontSize:11,titleFontSize:10,nameFontSize:12,spacing:8,signatureHeight:20,blockWidth:100,...r},n=e||new Date().toLocaleDateString("vi-VN");let o;s.align==="right"?o=this.pageWidth-this.margins.right-s.blockWidth:s.align==="center"?o=(this.pageWidth-s.blockWidth)/2:o=this.margins.left;const a=o+s.blockWidth/2;this.doc.setFontSize(s.fontSize);try{this.doc.setFont("Roboto","normal")}catch{this.doc.setFont("helvetica","normal")}this.doc.setTextColor(0,0,0);const l=this.doc.getTextWidth(n),c=a-l/2;this._drawText(n,c,this.currentY),this.currentY+=s.spacing,this.doc.setFontSize(s.titleFontSize);try{this.doc.setFont("Roboto","bold")}catch{this.doc.setFont("helvetica","bold")}const d=this.doc.getTextWidth(i),h=a-d/2;this._drawText(i,h,this.currentY),this.currentY+=5;const g="(Ký và ghi rõ họ tên)";this.doc.setFontSize(9);try{this.doc.setFont("Roboto","italic")}catch{this.doc.setFont("helvetica","italic")}this.doc.setTextColor(100,100,100);const u=this.doc.getTextWidth(g),f=a-u/2;this._drawText(g,f,this.currentY),this.currentY+=s.spacing,this.addSpace(s.signatureHeight),this.doc.setFontSize(s.nameFontSize);try{this.doc.setFont("Roboto","bold")}catch{this.doc.setFont("helvetica","bold")}this.doc.setTextColor(0,0,0);const p=this.doc.getTextWidth(t),b=a-p/2;return this._drawText(t,b,this.currentY),this.currentY+=15,this}async loadImageFromPath(t){try{const i=await fetch(t);if(!i.ok)throw new Error(`Không thể load hình từ ${t}`);const e=await i.blob();return new Promise((r,s)=>{const n=new FileReader;n.onload=function(o){r(o.target.result)},n.onerror=function(o){s(new Error("Lỗi khi đọc file"))},n.readAsDataURL(e)})}catch(i){return console.warn(`Không thể load hình từ ${t}:`,i.message),null}}async addSignatureWithImage(t,i,e,r=null,s={}){const n={align:"right",fontSize:11,titleFontSize:10,nameFontSize:12,dateFontSize:10,spacing:8,imageWidth:60,imageHeight:20,blockWidth:100,...s},o=r||new Date().toLocaleDateString("vi-VN");let a;n.align==="right"?a=this.pageWidth-this.margins.right-n.blockWidth:n.align==="center"?a=(this.pageWidth-n.blockWidth)/2:a=this.margins.left;const l=a+n.blockWidth/2;this.doc.setFontSize(n.fontSize);try{this.doc.setFont("Roboto","bold")}catch{this.doc.setFont("helvetica","bold")}this.doc.setTextColor(0,0,0),this.doc.setFontSize(n.dateFontSize);const c=this._decodeHtmlEntities(o),d=this.doc.getTextWidth(c),h=l-d/2;this._drawText(c,h,this.currentY),this.currentY+=n.spacing,this.doc.setFontSize(n.titleFontSize);try{this.doc.setFont("Roboto","bold")}catch{this.doc.setFont("helvetica","bold")}const g=this._decodeHtmlEntities(i),u=this.doc.getTextWidth(g),f=l-u/2;this._drawText(g,f,this.currentY),this.currentY+=5;const p=n.noteText??"(Ký và ghi rõ họ tên)";this.doc.setFontSize(9);try{this.doc.setFont("Roboto","italic")}catch{this.doc.setFont("helvetica","italic")}this.doc.setTextColor(100,100,100);const b=this._decodeHtmlEntities(p),m=this.doc.getTextWidth(b),y=l-m/2;this._drawText(b,y,this.currentY),this.currentY+=n.spacing,this.addSpace(5);let T=null;if(e&&(typeof e=="string"?e.startsWith("data:")?T=e:T=await this.loadImageFromPath(e):T=e),T){const P=l-n.imageWidth/2;this.addImage(T,P,this.currentY,n.imageWidth,n.imageHeight,{format:"JPEG"})}else if(n.nameTag&&n.nameTag.trim()){const P=this.doc.internal.getCurrentPageInfo().color||[0,0,0];this.doc.setTextColor(255,255,255),this.doc.setFontSize(9);try{this.doc.setFont("Roboto","italic")}catch{this.doc.setFont("helvetica","italic")}const D=this._decodeHtmlEntities(n.nameTag),O=this.doc.getTextWidth(D),A=l-O/2;this._drawText(D,A,this.currentY+n.imageHeight/2),this.doc.setTextColor(P[0]||0,P[1]||0,P[2]||0),this.addSpace(n.imageHeight+10)}else this.addSpace(n.imageHeight+10);this.doc.setFontSize(n.nameFontSize);try{this.doc.setFont("Roboto","bold")}catch{this.doc.setFont("helvetica","bold")}this.doc.setTextColor(0,0,0);const W=this._decodeHtmlEntities(t),w=this.doc.getTextWidth(W),N=l-w/2;return this._drawText(W,N,this.currentY),this.currentY+=15,this}async addSignatureFromFile(t,i,e,r=null,s={}){return await this.addSignatureWithImage(t,i,e,r,s)}async addSmartSignature(t,i,e={},r=null,s={}){const{imagePath:n=null,imageData:o=null,fallbackText:a=null,createFallback:l=!0}=e;let c=null;return n&&(c=await this.loadImageFromPath(n)),!c&&o&&(c=o),!c&&l&&(c=this.createTextSignature(a||t)),await this.addSignatureWithImage(t,i,c,r,s)}addSecondarySignature(t={}){const e={...{imageData:null,nameTag:"Secondary Signature",positions:["top-right"],width:15,height:15,margin:5,fontSize:8,showPageNumber:!1},...t},r=["top-left","top-right","bottom-left","bottom-right"],n=(Array.isArray(e.positions)?e.positions:[e.positions]).filter(a=>r.includes(a));if(n.length===0)return console.warn("No valid positions provided for secondary signature"),this;this.secondarySignatures||(this.secondarySignatures=[]),this.secondarySignatures.push({imageData:e.imageData,nameTag:e.nameTag,positions:n,width:e.width,height:e.height,margin:e.margin,fontSize:e.fontSize,showPageNumber:e.showPageNumber});const o=this.doc.internal.getNumberOfPages();for(let a=1;a<=o;a++)this.doc.setPage(a),this._renderSecondarySignature(e,a);return this}_renderSecondarySignature(t,i=null){const e=this.doc.internal.pageSize.width,r=this.doc.internal.pageSize.height;i===null&&(i=this.doc.internal.getCurrentPageInfo().pageNumber);for(const s of t.positions){let n,o;switch(s){case"top-left":n=t.margin,o=t.margin;break;case"top-right":n=e-t.width-t.margin,o=t.margin;break;case"bottom-left":n=t.margin,o=r-t.height-t.margin;break;case"bottom-right":n=e-t.width-t.margin,o=r-t.height-t.margin;break;default:continue}if(t.imageData)try{this.doc.addImage(t.imageData,"PNG",n,o,t.width,t.height)}catch(a){console.warn("Failed to add secondary signature image:",a),this._renderSecondarySignatureNameTag(n,o,t,i)}else this._renderSecondarySignatureNameTag(n,o,t,i)}}_renderSecondarySignatureNameTag(t,i,e,r){const s=this.doc.getTextColor(),n=this.doc.internal.getFontSize(),o=this.doc.getFont();this.doc.setTextColor(154,166,178),this.doc.setFontSize(e.fontSize);try{this.doc.setFont("Roboto","italic")}catch{this.doc.setFont("helvetica","italic")}let a=e.nameTag;e.showPageNumber&&r&&(a=`${e.nameTag}_${r}`);const l=this._decodeHtmlEntities(a),c=this.doc.getTextWidth(l),d=t+(e.width-c),h=i+e.height/2+e.fontSize/2+3;this._drawText(l,d,h),this.doc.setTextColor(s),this.doc.setFontSize(n),this.doc.setFont(o.fontName,o.fontStyle)}_addSecondarySignaturesToNewPage(){if(this.secondarySignatures&&this.secondarySignatures.length>0)for(const t of this.secondarySignatures)this._renderSecondarySignature(t)}createTextSignature(t,i=120,e=40){const r=document.createElement("canvas"),s=r.getContext("2d");r.width=i,r.height=e,s.fillStyle="white",s.fillRect(0,0,i,e),s.fillStyle="#1a5490",s.font='italic bold 14px cursive, "Times New Roman", serif';const n=this._decodeHtmlEntities(t),o=s.measureText(n).width,a=(i-o)/2,l=e/2+5;return s.fillText(n,a,l),s.strokeStyle="#1a5490",s.lineWidth=1.5,s.beginPath(),s.moveTo(a-5,l+8),s.lineTo(a+o+5,l+8),s.stroke(),r.toDataURL("image/png")}addSimpleSignature(t,i,e=null,r={}){const s={fontSize:11,lineWidth:100,spacing:8,...r},n=e||this.margins.left;return this.addText(i,n,null,{fontSize:s.fontSize,fontStyle:"bold"}),this.addSpace(s.spacing),this.doc.setLineWidth(.5),this.doc.line(n,this.currentY,n+s.lineWidth,this.currentY),this.addSpace(5),this.addText(t,n,null,{fontSize:s.fontSize-1}),this.addSpace(15),this}addDualSignature(t,i){const r=this.margins.left,s=this.pageWidth/2+10,n=r+90/2,o=s+90/2,a=this.currentY;this.currentY=a;const l=t.date||"";this.renderCenteredText(l,n,this.currentY,11,"normal"),this.currentY+=8,this.renderCenteredText(t.title,n,this.currentY,10,"bold"),this.currentY+=5;const c=t.note||"(Ký và ghi rõ họ tên)";if(this.renderCenteredText(c,n,this.currentY,9,"italic",[100,100,100]),this.currentY+=25,t.signaturePath&&t.signaturePath.trim())try{this.doc.addImage(t.signaturePath,"PNG",n-15,this.currentY-20,30,15)}catch(u){console.warn("Không thể thêm chữ ký trái:",u)}else if(t.nameTag&&t.nameTag.trim()){const u=this.doc.internal.getCurrentPageInfo().color||[0,0,0];this.doc.setTextColor(255,255,255);const f=this._decodeHtmlEntities(t.nameTag);this._drawText(f,n-this.doc.getTextWidth(f)/2,this.currentY-15),this.doc.setTextColor(u[0]||0,u[1]||0,u[2]||0)}this.renderCenteredText(t.name,n,this.currentY,11,"bold");const d=this.currentY;this.currentY=a;const h=i.date||"";this.renderCenteredText(h,o,this.currentY,11,"normal"),this.currentY+=8,this.renderCenteredText(i.title,o,this.currentY,10,"bold"),this.currentY+=5;const g=i.note||"(Ký và ghi rõ họ tên)";if(this.renderCenteredText(g,o,this.currentY,9,"italic",[100,100,100]),this.currentY+=25,i.signaturePath&&i.signaturePath.trim())try{this.doc.addImage(i.signaturePath,"PNG",o-15,this.currentY-20,30,15)}catch(u){console.warn("Không thể thêm chữ ký phải:",u)}else if(i.nameTag&&i.nameTag.trim()){const u=this.doc.internal.getCurrentPageInfo().color||[0,0,0];this.doc.setTextColor(255,255,255);const f=this._decodeHtmlEntities(i.nameTag);this._drawText(f,o-this.doc.getTextWidth(f)/2,this.currentY-15),this.doc.setTextColor(u[0]||0,u[1]||0,u[2]||0)}return this.renderCenteredText(i.name,o,this.currentY,11,"bold"),this.currentY=Math.max(d,this.currentY)+10,this}renderCenteredText(t,i,e,r=11,s="normal",n=[0,0,0]){if(Array.isArray(t)){const o=this.currentY;this.currentY=e;let a=0;t.forEach(c=>{let d=typeof c=="string"?c:c.text;d=this._decodeHtmlEntities(d);const h=typeof c=="object"&&c.fontSize?c.fontSize:r,g=typeof c=="object"&&c.style?c.style:s;this.doc.setFontSize(h);try{this.doc.setFont("Roboto",g)}catch{this.doc.setFont("helvetica",g)}a+=this.doc.getTextWidth(d)});let l=i-a/2;t.forEach(c=>{const d=typeof c=="string"?c:c.text,h=typeof c=="object"&&c.fontSize?c.fontSize:r,g=typeof c=="object"&&c.style?c.style:s,u=typeof c=="object"&&c.color?c.color:n;this.doc.setFontSize(h);try{this.doc.setFont("Roboto",g)}catch{this.doc.setFont("helvetica",g)}this.doc.setTextColor(u[0],u[1],u[2]),this._drawText(d,l,e),l+=this.doc.getTextWidth(d)}),this.currentY=o}else if(typeof t=="object"&&t.text){const o=t.text,a=t.fontSize||r,l=t.style||s,c=t.color||n;this.doc.setFontSize(a);try{this.doc.setFont("Roboto",l)}catch{this.doc.setFont("helvetica",l)}this.doc.setTextColor(c[0],c[1],c[2]);const d=this._decodeHtmlEntities(o),h=this.doc.getTextWidth(d);this._drawText(d,i-h/2,e)}else{let o=t.toString();o=this._decodeHtmlEntities(o),this.doc.setFontSize(r);try{this.doc.setFont("Roboto",s)}catch{this.doc.setFont("helvetica",s)}this.doc.setTextColor(n[0],n[1],n[2]);const a=this.doc.getTextWidth(o);this._drawText(o,i-a/2,e)}}addLeaderDots(t,i,e={}){t=this._decodeHtmlEntities(t),i=this._decodeHtmlEntities(i);const r={fontSize:11,fontStyle:"normal",color:[0,0,0],dotChar:".",dotSpacing:3,minDots:3,leftPadding:5,rightPadding:5,lineHeight:6,...e};this.doc.setFontSize(r.fontSize);try{this.doc.setFont("Roboto",r.fontStyle)}catch{this.doc.setFont("helvetica",r.fontStyle)}const s=Array.isArray(r.color)?r.color:[0,0,0];this.doc.setTextColor(...s);const n=this.doc.getTextWidth(t),o=this.doc.getTextWidth(i),a=this.doc.getTextWidth(r.dotChar),l=this.margins.left,c=this.pageWidth-this.margins.right-o,d=l+n+r.leftPadding,h=c-r.rightPadding,g=h-d,u=Math.max(r.minDots,Math.floor(g/(a+r.dotSpacing)));this.checkPageBreak(r.lineHeight+3),this._drawText(t,l,this.currentY);let f=d;for(let p=0;p<u;p++)f+a<=h&&(this._drawText(r.dotChar,f,this.currentY),f+=a+r.dotSpacing);return this._drawText(i,c,this.currentY),this.currentY+=r.lineHeight,this}addTableOfContents(t,i={}){const e={title:"MỤC LỤC",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},itemOptions:{fontSize:11,fontStyle:"normal",indent:0},subItemOptions:{fontSize:10,fontStyle:"normal",indent:15},...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),t.forEach(r=>{let s=typeof r=="string"?r:r.title;s=this._decodeHtmlEntities(s);const n=typeof r=="object"?r.page:"",a=typeof r=="object"&&r.isSubItem?e.subItemOptions:e.itemOptions,l=a.indent||0,c=" ".repeat(l/3)+s;this.addLeaderDots(c,n.toString(),{...a,leftPadding:5,rightPadding:5})}),this}addPriceList(t,i={}){const e={title:"BẢNG GIÁ",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},itemOptions:{fontSize:11,fontStyle:"normal"},currency:"VNĐ",...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),t.forEach(r=>{const s=r.name||r.title,n=r.price||r.cost||0,o=this._decodeHtmlEntities(s),a=this.formatPrice(n,e.currency),l=this._decodeHtmlEntities(a);this.addLeaderDots(o,l,{...e.itemOptions,leftPadding:8,rightPadding:8})}),this}addMenu(t,i={}){const e={title:"THỰC ĐƠN",titleOptions:{fontSize:18,fontStyle:"bold",align:"center",color:[139,0,0]},sectionOptions:{fontSize:14,fontStyle:"bold",color:[0,0,139]},itemOptions:{fontSize:11,fontStyle:"normal"},currency:"VNĐ",...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(15)),t.forEach(r=>{this.addText(r.name,null,null,e.sectionOptions),this.addSpace(8),r.items.forEach(s=>{const n=`${s.name}${s.description?` - ${s.description}`:""}`,o=this.formatPrice(s.price,e.currency),a=this._decodeHtmlEntities(n),l=this._decodeHtmlEntities(o);this.addLeaderDots(a,l,{...e.itemOptions,leftPadding:10,rightPadding:10,dotChar:".",dotSpacing:2})}),this.addSpace(12)}),this}addIndex(t,i={}){const e={title:"CHỈ MỤC",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},itemOptions:{fontSize:10,fontStyle:"normal"},columns:2,...i};if(e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),e.columns===1)t.forEach(r=>{const s=this._decodeHtmlEntities(r.term),n=this._decodeHtmlEntities(r.pages.join(", "));this.addLeaderDots(s,n,{...e.itemOptions,leftPadding:5,rightPadding:5,lineHeight:5})});else{const r=Math.ceil(t.length/e.columns),s=(this.pageWidth-this.margins.left-this.margins.right)/e.columns;for(let n=0;n<e.columns;n++){const o=n*r,a=Math.min(o+r,t.length),l=t.slice(o,a),c=this.currentY,d=this.margins.left+n*s;n>0&&(this.currentY=c),l.forEach(h=>{const g=this._decodeHtmlEntities(h.term),u=this._decodeHtmlEntities(h.pages.join(", ")),f=this.doc.getTextWidth(g),p=this.doc.getTextWidth(u);this.doc.setFontSize(e.itemOptions.fontSize);const b=this.doc.getTextWidth("."),m=s-f-p-15,y=Math.max(3,Math.floor(m/(b+2)));this._drawText(g,d,this.currentY);let T=d+f+5;for(let w=0;w<y;w++)this._drawText(".",T,this.currentY),T+=b+2;const W=d+s-p-5;this._drawText(u,W,this.currentY),this.currentY+=5})}}return this}formatPrice(t,i="VNĐ"){return typeof t=="number"?t.toLocaleString("vi-VN")+" "+i:t.toString()+" "+i}addFillInLine(t="",i={}){t=this._decodeHtmlEntities(t);const e={lineCount:1,lineLength:100,lineSpacing:8,lineStyle:"dots",lineWidth:.5,lineColor:[0,0,0],dotSpacing:1,dotChar:".",labelPosition:"left",labelOptions:{fontSize:11,fontStyle:"normal",color:[0,0,0],spacing:5},align:"left",showPlaceholder:!1,placeholderText:"(điền thông tin)",placeholderOptions:{fontSize:9,fontStyle:"italic",color:[150,150,150]}},r={...e,...i,labelOptions:{...e.labelOptions,...i.labelOptions||{}},placeholderOptions:{...e.placeholderOptions,...i.placeholderOptions||{}}};let s;if(this.currentY,r.align==="center"?s=(this.pageWidth-r.lineLength)/2:r.align==="right"?s=this.pageWidth-this.margins.right-r.lineLength:s=this.margins.left,t&&r.labelPosition!=="none"){this.doc.setFontSize(r.labelOptions.fontSize);try{this.doc.setFont("Roboto",r.labelOptions.fontStyle)}catch{this.doc.setFont("helvetica",r.labelOptions.fontStyle)}const a=Array.isArray(r.labelOptions.color)?r.labelOptions.color:[0,0,0];this.doc.setTextColor(...a);const l=this.doc.getTextWidth(t);if(r.labelPosition==="above"){const c=r.align==="center"?(this.pageWidth-l)/2:r.align==="right"?this.pageWidth-this.margins.right-l:this.margins.left;this._drawText(t,c,this.currentY),this.currentY+=r.labelOptions.spacing}else r.labelPosition==="left"&&(this._drawText(t,this.margins.left,this.currentY),s=this.margins.left+l+r.labelOptions.spacing,r.lineLength=Math.min(r.lineLength,this.pageWidth-this.margins.right-s))}const n=(r.lineCount-1)*r.lineSpacing+10;this.checkPageBreak(n),this.doc.setLineWidth(r.lineWidth);const o=Array.isArray(r.lineColor)?r.lineColor:[0,0,0];this.doc.setDrawColor(...o);for(let a=0;a<r.lineCount;a++){const l=this.currentY+a*r.lineSpacing;if(r.lineStyle==="dots"){this.doc.setFontSize(r.labelOptions.fontSize);try{this.doc.setFont("Roboto","normal")}catch{this.doc.setFont("helvetica","normal")}const c=Array.isArray(r.lineColor)?r.lineColor:[0,0,0];this.doc.setTextColor(...c);const d=this.doc.getTextWidth(r.dotChar),h=Math.floor(r.lineLength/(d+r.dotSpacing));for(let g=0;g<h;g++){const u=s+g*(d+r.dotSpacing);u+d<=s+r.lineLength&&this._drawText(r.dotChar,u,l)}}else r.lineStyle==="dashed"?this.doc.setLineDashPattern([3,2],0):r.lineStyle==="dotted"?this.doc.setLineDashPattern([1,2],0):this.doc.setLineDashPattern([],0),this.doc.line(s,l,s+r.lineLength,l);if(r.showPlaceholder&&r.placeholderText){this.doc.setFontSize(r.placeholderOptions.fontSize);try{this.doc.setFont("Roboto",r.placeholderOptions.fontStyle)}catch{this.doc.setFont("helvetica",r.placeholderOptions.fontStyle)}const c=Array.isArray(r.placeholderOptions.color)?r.placeholderOptions.color:[150,150,150];this.doc.setTextColor(...c);const d=l-2;this._drawText(r.placeholderText,s+5,d)}}if(this.doc.setLineDashPattern([],0),t&&r.labelPosition==="right"){this.doc.setFontSize(r.labelOptions.fontSize);try{this.doc.setFont("Roboto",r.labelOptions.fontStyle)}catch{this.doc.setFont("helvetica",r.labelOptions.fontStyle)}const a=Array.isArray(r.labelOptions.color)?r.labelOptions.color:[0,0,0];this.doc.setTextColor(...a);const l=s+r.lineLength+r.labelOptions.spacing;this._drawText(t,l,this.currentY)}if(t&&r.labelPosition==="below"){const a=this.currentY+(r.lineCount-1)*r.lineSpacing;this.currentY=a+r.labelOptions.spacing;const l=this.doc.getTextWidth(t),c=r.align==="center"?(this.pageWidth-l)/2:r.align==="right"?this.pageWidth-this.margins.right-l:this.margins.left;this._drawText(t,c,this.currentY)}return this.currentY+=(r.lineCount-1)*r.lineSpacing+10,this}addFillInForm(t,i={}){const e={title:null,titleOptions:{fontSize:14,fontStyle:"bold",color:[0,0,0]},fieldSpacing:12,columns:1,...i};if(e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(8)),e.columns===1)t.forEach(r=>{const s={lineLength:150,labelPosition:"left",...r.options};this.addFillInLine(r.label||"",s),this.addSpace(e.fieldSpacing-10)});else{const r=Math.ceil(t.length/e.columns),s=(this.pageWidth-this.margins.left-this.margins.right)/e.columns;for(let n=0;n<t.length;n+=r){const o=t.slice(n,n+r),a=Math.floor(n/r),l=this.currentY;o.forEach((c,d)=>{a>0&&(this.currentY=l+d*e.fieldSpacing);const h={lineLength:s-20,labelPosition:"above",align:"left",...c.options},g=this.margins.left+a*s,u=this.margins.left;this.margins.left=g,this.addFillInLine(c.label||"",h),this.margins.left=u,a===0&&this.addSpace(e.fieldSpacing-10)})}}return this}addSignatureFillIn(t=[],i={}){const e={layout:"horizontal",signatureWidth:120,dateWidth:80,spacing:20,showDate:!0,dateLabel:"Ngày:",signatureLabel:"Chữ ký:",nameLabel:"Họ tên:",...i};if(e.layout==="horizontal"){const r=t.length*(e.signatureWidth+e.spacing)-e.spacing;let s=(this.pageWidth-r)/2;t.forEach((n,o)=>{const a=s+o*(e.signatureWidth+e.spacing),l=this.margins.left;this.margins.left=a,e.showDate&&this.addFillInLine(e.dateLabel,{lineLength:e.dateWidth,labelPosition:"left",align:"left"}),n.title&&this.addText(n.title,a+(e.signatureWidth-this.doc.getTextWidth(n.title))/2,null,{fontSize:10,fontStyle:"bold"}),this.addFillInLine(e.signatureLabel,{lineLength:e.signatureWidth,labelPosition:"above",align:"left"}),this.addFillInLine(e.nameLabel,{lineLength:e.signatureWidth,labelPosition:"left",align:"left"}),this.margins.left=l})}else t.forEach(r=>{r.title&&this.addText(r.title,null,null,{fontSize:12,fontStyle:"bold",align:"center"}),e.showDate&&this.addFillInLine(e.dateLabel,{lineLength:e.dateWidth,labelPosition:"left",align:"center"}),this.addFillInLine(e.signatureLabel,{lineLength:e.signatureWidth,labelPosition:"above",align:"center"}),this.addFillInLine(e.nameLabel,{lineLength:e.signatureWidth,labelPosition:"left",align:"center"}),this.addSpace(e.spacing)});return this}addDottedFillIn(t="",i={}){const e={lineStyle:"dots",dotChar:".",dotSpacing:2,lineLength:100,labelPosition:"left",...i};return this.addFillInLine(t,e)}addDottedForm(t,i={}){const e={fieldDefaults:{lineStyle:"dots",dotChar:".",dotSpacing:2},...i},r=t.map(s=>({...s,options:{...e.fieldDefaults,...s.options}}));return this.addFillInForm(r,e)}addDottedSignature(t=[],i={}){const e={lineStyle:"dots",dotChar:".",dotSpacing:2,...i},r=this.addFillInLine.bind(this);this.addFillInLine=(n,o={})=>r(n,{lineStyle:"dots",dotChar:".",dotSpacing:2,...o});const s=this.addSignatureFillIn(t,e);return this.addFillInLine=r,s}addCustomDottedLine(t="",i=".",e=2,r=100,s={}){return this.addFillInLine(t,{lineStyle:"dots",dotChar:i,dotSpacing:e,lineLength:r,...s})}addMixedText(t,i={}){const r={...{fontSize:12,color:[0,0,0],maxWidth:this.pageWidth-this.margins.left-this.margins.right,align:"left",lineHeight:this.lineHeight},...i};r.lineHeight=parseFloat(r.lineHeight)||5,r.fontSize=parseFloat(r.fontSize)||12,r.maxWidth=parseFloat(r.maxWidth)||this.pageWidth-this.margins.left-this.margins.right;let s=r.x||this.margins.left,n=this.currentY,o=[],a=0;return this.checkPageBreak(r.lineHeight+10),n=this.currentY,t.forEach((l,c)=>{let d=typeof l=="string"?l:l.text;d=this._decodeHtmlEntities(d);let h="normal";if(typeof l=="object"&&l.style){if(typeof l.style=="string")h=l.style;else if(typeof l.style=="object"){const p=l.style;p.bold&&p.italic?h="bolditalic":p.bold?h="bold":p.italic?h="italic":h="normal"}}const g=typeof l=="object"&&l.color?l.color:typeof l=="object"&&l.style&&l.style.color?l.style.color:r.color;let u=typeof l=="object"&&l.fontSize?l.fontSize:typeof l=="object"&&l.style&&l.style.fontSize?l.style.fontSize:r.fontSize;u=parseFloat(u)||r.fontSize||12,this.doc.setFontSize(u);try{this.doc.setFont("Roboto",h)}catch{this.doc.setFont("helvetica",h)}if(!d)return;const f=String(d).split(" ");f.forEach((p,b)=>{const m=b<f.length-1?p+" ":p,y=this.doc.getTextWidth(m);if(a+y>r.maxWidth&&o.length>0){this.renderMixedLine(o,s,n,r,!1),n+=r.lineHeight;const w=this.currentY;this.checkPageBreak(r.lineHeight+5),this.currentY<w&&(n=this.currentY),s=r.x||this.margins.left,o=[],a=0}const T=typeof l=="object"&&l.style&&typeof l.style=="object"?l.style.underline:!1,W=typeof l=="object"&&l.style&&typeof l.style=="object"?l.style.strikethrough:!1;o.push({text:m,style:h,color:this._parseColorToArray(g),fontSize:u,width:y,underline:T,strikethrough:W}),a+=y})}),o.length>0&&(this.renderMixedLine(o,s,n,r,!0),n+=r.lineHeight),r.spacing!==void 0&&r.spacing,this.currentY=n,this}renderMixedLine(t,i,e,r,s=!1){if(!t||t.length===0)return;let n=i;if(r.align==="center"){const o=t.reduce((a,l)=>a+l.width,0);n=(this.pageWidth-o)/2}else if(r.align==="right"){const o=t.reduce((a,l)=>a+l.width,0);n=this.pageWidth-this.margins.right-o}else if(r.align==="justify"&&!s&&t.length>1){this.renderJustifiedMixedLine(t,i,e,r);return}t.forEach(o=>{this.doc.setFontSize(o.fontSize);try{this.doc.setFont("Roboto",o.style)}catch{this.doc.setFont("helvetica",o.style)}if(this.doc.setTextColor(o.color[0],o.color[1],o.color[2]),this._drawText(o.text,n,e),o.underline){const a=this.doc.getTextWidth(o.text.trimEnd()),l=e+1;this.doc.setDrawColor(o.color[0],o.color[1],o.color[2]),this.doc.setLineWidth(.3),this.doc.line(n,l,n+a,l)}if(o.strikethrough){const a=this.doc.getTextWidth(o.text.trimEnd()),l=e-o.fontSize*.12;this.doc.setDrawColor(o.color[0],o.color[1],o.color[2]),this.doc.setLineWidth(.3),this.doc.line(n,l,n+a,l)}n+=o.width})}renderJustifiedMixedLine(t,i,e,r){if(t.length<=1){this.renderMixedLine(t,i,e,{...r,align:"left"});return}let s=0;t.forEach(c=>{this.doc.setFontSize(c.fontSize);try{this.doc.setFont("Roboto",c.style)}catch{this.doc.setFont("helvetica",c.style)}s+=this.doc.getTextWidth(c.text.trimEnd())});const n=t.length-1,a=(r.maxWidth-s)/n;let l=i;t.forEach((c,d)=>{this.doc.setFontSize(c.fontSize);try{this.doc.setFont("Roboto",c.style)}catch{this.doc.setFont("helvetica",c.style)}this.doc.setTextColor(c.color[0],c.color[1],c.color[2]);const h=c.text.trimEnd(),g=this.doc.getTextWidth(h);if(this._drawText(h,l,e),c.underline){const u=e+1;this.doc.setDrawColor(c.color[0],c.color[1],c.color[2]),this.doc.setLineWidth(.3),this.doc.line(l,u,l+g,u)}if(c.strikethrough){const u=e-c.fontSize*.12;this.doc.setDrawColor(c.color[0],c.color[1],c.color[2]),this.doc.setLineWidth(.3),this.doc.line(l,u,l+g,u)}l+=g,d<t.length-1&&(l+=a)})}addMixedParagraph(t,i={}){const e={fontSize:10,color:[0,0,0],lineHeight:5,align:"left",maxWidth:this.pageWidth-this.margins.left-this.margins.right,spacing:1,...i};return!Array.isArray(t)||t.length===0?(console.warn("addMixedParagraph: textParts phải là array không rỗng"),this):(this.addMixedText(t,e),this.currentY+=e.spacing,this)}createTextPart(t,i="normal",e=null,r=null){const s={text:t,style:i};return e&&(s.color=Array.isArray(e)?e:[0,0,0]),r&&(s.fontSize=r),s}bold(t,i=null,e=null){return this.createTextPart(t,"bold",i,e)}italic(t,i=null,e=null){return this.createTextPart(t,"italic",i,e)}boldItalic(t,i=null,e=null){return this.createTextPart(t,"bolditalic",i,e)}normal(t,i=null,e=null){return this.createTextPart(t,"normal",i,e)}colored(t,i,e="normal",r=null){return this.createTextPart(t,e,i,r)}addStyledParagraph(t,i={}){return Array.isArray(t)||(t=[t]),this.addMixedParagraph(t,i)}addNumberedText(t,i={}){t=this._decodeHtmlEntities(t);const e={fontSize:11,fontStyle:"normal",color:[0,0,0],numberStyle:"decimal",numberFormat:"{number}.",startNumber:1,indent:20,numberWidth:15,lineHeight:null,maxWidth:null,align:"left",showIndex:!0,lineSpacing:1.3,...i};e.lineHeight===null&&(e.lineHeight=Math.max(this.lineHeight,Math.ceil(e.fontSize*e.lineSpacing))),e.maxWidth||(e.maxWidth=this.pageWidth-this.margins.left-this.margins.right-e.indent),this.currentNumberByStyle||(this.currentNumberByStyle={}),this.currentNumberByStyle[e.numberStyle]||(this.currentNumberByStyle[e.numberStyle]=e.startNumber);const r=this.currentNumberByStyle[e.numberStyle];let s="";switch(e.numberStyle){case"decimal":s=r.toString();break;case"roman":s=this.toRomanNumeral(r);break;case"alpha":s=this.toAlphaNumeral(r);break;case"bullet":s="•";break;default:s=r.toString()}const n=e.numberFormat.replace("{number}",s);this.doc.setFontSize(e.fontSize);try{this.doc.setFont("Roboto",e.fontStyle)}catch{this.doc.setFont("helvetica",e.fontStyle)}const o=Array.isArray(e.color)?e.color:[0,0,0];this.doc.setTextColor(...o);const a=this.doc.splitTextToSize(t,e.maxWidth);if(e.skipPageBreakCheck!==!0){const h=a.length*(3+e.lineHeight);this.checkPageBreak(h+10)}let l=this.margins.left,c=this.margins.left+e.indent,d=this.currentY;return a.forEach((h,g)=>{if(a.length>5&&e.skipPageBreakCheck!==!0&&(this.checkPageBreak(3+e.lineHeight+5),d=this.currentY),g===0&&e.showIndex){if(e.align==="center"){const u=this.doc.getTextWidth(n+" "+h),f=(this.pageWidth-u)/2;l=f,c=f+this.doc.getTextWidth(n)+5}else if(e.align==="right"){const u=this.doc.getTextWidth(n+" "+h),f=this.pageWidth-this.margins.right-u;l=f,c=f+this.doc.getTextWidth(n)+5}else l=this.margins.left,c=this.margins.left+e.indent;this._drawText(n,l,d)}if(e.align==="center")if(g===0&&e.showIndex)this._drawText(h,c,d);else{const u=this.doc.getTextWidth(h),f=(this.pageWidth-u)/2;this._drawText(h,f,d)}else if(e.align==="right")if(g===0&&e.showIndex)this._drawText(h,c,d);else{const u=this.doc.getTextWidth(h),f=this.pageWidth-this.margins.right-u;this._drawText(h,f,d)}else if(e.align==="justify"){const u=g===a.length-1;g===0?(c=this.margins.left+e.indent,!u&&h.trim().length>0?this.drawJustifiedText(h,c,d,e.maxWidth,e):this._drawText(h,c,d)):(c=this.margins.left+e.indent,!u&&h.trim().length>0?this.drawJustifiedText(h,c,d,e.maxWidth,e):this._drawText(h,c,d))}else g===0?c=this.margins.left+e.indent:c=this.margins.left+e.indent,this._drawText(h,c,d);d+=3+e.lineHeight}),this.currentY=d,this.currentNumberByStyle[e.numberStyle]++,this}resetNumbering(t="decimal",i=1){return this.currentNumberByStyle||(this.currentNumberByStyle={}),this.currentNumberByStyle[t]=i,this}addNumberedList(t,i={}){const e={title:null,titleOptions:{fontSize:14,fontStyle:"bold",color:[0,0,0],align:"left"},itemOptions:{fontSize:11,fontStyle:"normal",color:[0,0,0],numberStyle:"decimal",indent:20,align:"left"},spacing:.5,resetNumbers:!0,...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(5)),e.resetNumbers&&this.resetNumbering(e.itemOptions.numberStyle,1),t.forEach((r,s)=>{const n=typeof r=="string"?r:r.text,o=typeof r=="object"?{...e.itemOptions,...r.options}:e.itemOptions;this.doc.setFontSize(o.fontSize||11);const a=o.maxWidth||this.pageWidth-this.margins.left-this.margins.right-(o.indent||20),c=this.doc.splitTextToSize(n,a).length*((o.lineHeight||this.lineHeight)+3)+(e.spacing||.5)+10;this.checkPageBreak(c);const d={...o,skipPageBreakCheck:!0};this.addNumberedText(n,d),s<t.length-1&&this.addSpace(e.spacing)}),this}addMultiLevelList(t,i={}){const e={level1:{numberStyle:"decimal",numberFormat:"{number}.",indent:20,fontSize:11},level2:{numberStyle:"alpha",numberFormat:"{number})",indent:35,fontSize:10},level3:{numberStyle:"roman",numberFormat:"({number})",indent:50,fontSize:10},level4:{numberStyle:"bullet",numberFormat:"{number}",indent:65,fontSize:9},spacing:2,...i};this.resetNumbering("decimal",1),this.resetNumbering("alpha",1),this.resetNumbering("roman",1);const r=(s,n=1)=>{const o=`level${Math.min(n,4)}`,a=e[o];s.forEach((l,c)=>{if(typeof l=="string")this.addNumberedText(l,a);else if(l.text){const d={...a,...l.options};this.addNumberedText(l.text,d),l.subItems&&Array.isArray(l.subItems)&&(this.addSpace(e.spacing),r(l.subItems,n+1))}c<s.length-1&&this.addSpace(e.spacing)})};return r(t),this}toRomanNumeral(t){const i=[["M",1e3],["CM",900],["D",500],["CD",400],["C",100],["XC",90],["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]];let e="";for(let[r,s]of i){const n=Math.floor(t/s);e+=r.repeat(n),t-=s*n}return e.toLowerCase()}toAlphaNumeral(t){let i="";for(;t>0;)t--,i=String.fromCharCode(97+t%26)+i,t=Math.floor(t/26);return i}addOutline(t,i={}){const e={title:"OUTLINE",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},h1Options:{numberStyle:"decimal",numberFormat:"{number}.",fontSize:12,fontStyle:"bold",indent:15},h2Options:{numberStyle:"decimal",numberFormat:"{number}.{parent}.",fontSize:11,fontStyle:"normal",indent:25},h3Options:{numberStyle:"decimal",numberFormat:"{number}.{parent}.{grandparent}.",fontSize:10,fontStyle:"normal",indent:35},showPageNumbers:!0,...i};e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),this.resetNumbering("h1",1),this.resetNumbering("h2",1),this.resetNumbering("h3",1);const r=(s,n=1,o=[])=>{s.forEach(a=>{const l=typeof a=="string"?a:a.title,c=typeof a=="object"?a.page:"",d=typeof a=="object"?a.subItems:null;let h=`h${Math.min(n,3)}`,g=e[`${h}Options`],u=this.currentNumberByStyle[h]||1,f=u.toString();g.numberFormat.includes("{parent}")&&o.length>0&&(f=f+"."+o[o.length-1]),g.numberFormat.includes("{grandparent}")&&o.length>1&&(f=f+"."+o[o.length-2]);const p=g.numberFormat.replace("{number}",u).replace("{parent}",o[o.length-1]||"").replace("{grandparent}",o[o.length-2]||"");if(e.showPageNumbers&&c?this.addLeaderDots(p+" "+l,c.toString(),{fontSize:g.fontSize,fontStyle:g.fontStyle,leftPadding:g.indent}):this.addText(p+" "+l,this.margins.left+g.indent,null,{fontSize:g.fontSize,fontStyle:g.fontStyle}),this.currentNumberByStyle||(this.currentNumberByStyle={}),this.currentNumberByStyle[h]=u+1,d&&Array.isArray(d)){const b=[...o,u];this.resetNumbering(`h${n+1}`,1),r(d,n+1,b)}})};return r(t),this}getPageInfo(){return{currentPage:this.doc.internal.getCurrentPageInfo().pageNumber,totalPages:this.doc.internal.getNumberOfPages(),pageSize:this.doc.internal.pageSize,currentY:this.currentY}}alignColons(t,i=1){const e=t.map(n=>{const[o,a]=n.split(":");return{left:o??"",right:a??""}}),r=Math.max(...e.map(n=>n.left.trimEnd().length)),s=" ".repeat(i);return e.map(n=>{const o=" ".repeat(r-n.left.trimEnd().length);return`${n.left.trimEnd()}${o} :${s}${n.right.trimStart()}`})}}class E{constructor(){this.pdfService=null,this.margins={left:15,right:15,top:20,bottom:20},this.pageWidth=210,this.contentWidth=this.pageWidth-this.margins.left-this.margins.right}calculateX(t){const i=t.indent||0,e=t.marginLeft||0;return this.margins.left+i+e}render(t,i={}){return this.pdfService=new v,t.margins&&(this.margins={...this.margins,...t.margins},this.contentWidth=this.pageWidth-this.margins.left-this.margins.right),t.pages.forEach((e,r)=>{r>0&&this.pdfService.addNewPage(),this.pdfService.resetPosition(this.margins.top),this.renderPage(e,i)}),this}cleanContent(t){if(!t)return"";let i=String(t);return i=i.replace(/<br\s*\/?>/gi,`
`),i=i.replace(/<\/p>\s*<p[^>]*>/gi,`
`),i=i.replace(/<[^>]*>/g,""),this.pdfService._decodeHtmlEntities(i)}renderPage(t,i){t.elements.forEach(e=>{switch(e.content&&(e.content=this.pdfService._decodeHtmlEntities(e.content)),e.type){case"text":this.renderText(e,i);break;case"richtext":this.renderRichText(e,i);break;case"heading":this.renderHeading(e,i);break;case"table":this.renderTable(e,i);break;case"image":this.renderImage(e,i);break;case"line":this.renderLine(e);break;case"space":this.pdfService.addSpace(e.height||10);break;case"evalblock":this.renderEvalBlock(e,i);break;case"codeblock":this.renderCodeBlock(e,i);break}})}renderRichText(t,i){const e=t.segments||[],r=t.style||{},s=e.map(h=>({text:this.replaceVariables(h.text,i),style:h.style})),n=this.calculateX(t),o=r.lineHeight||5,a={fontSize:r.fontSize||12,color:this.parseColor(r.color),align:r.align||"left",lineHeight:o,x:n,maxWidth:t.width||this.contentWidth};if(!s.some(h=>h.text&&(h.text.includes("___BR___")||h.text.includes("___HR___")||h.text.includes("___PAGEBREAK___")))){const h=s.map(g=>({...g,text:g.text?g.text.replace(/___TAB___/g,"    "):g.text}));this.pdfService.addMixedParagraph(h,a);return}let c=s.map(h=>h.text||"").join("");c=c.replace(/___TAB___/g,"    ");const d=c.split(/(___BR___|___HR___|___PAGEBREAK___)/);for(const h of d)if(h==="___BR___")this.pdfService.addSpace(this.pdfService.lineHeight);else if(h==="___HR___")this.pdfService.addHorizontalLine();else if(h==="___PAGEBREAK___")this.pdfService.addNewPage();else if(h.trim()){const g=[{text:h.trim(),style:{}}];this.pdfService.addMixedParagraph(g,a)}}renderText(t,i){let e=this.replaceVariables(t.content,i);const r=t.style||{},s=r.lineHeight||5,n={fontSize:r.fontSize||12,fontStyle:this.mapFontStyle(r),color:this.parseColor(r.color),align:r.align||"left",lineHeight:s},o=this.calculateX(t);if(e=e.replace(/___TAB___/g,"    "),!e.includes("___BR___")&&!e.includes("___HR___")&&!e.includes("___PAGEBREAK___")){this.pdfService.addText(e,o,null,n);return}const a=e.split(/(___BR___|___HR___|___PAGEBREAK___)/);for(const l of a)l==="___BR___"?this.pdfService.addSpace(s):l==="___HR___"?this.pdfService.addHorizontalLine():l==="___PAGEBREAK___"?this.pdfService.addNewPage():l.trim()&&this.pdfService.addText(l.trim(),o,null,n)}renderHeading(t,i){var s,n,o;const e=this.replaceVariables(t.content,i);switch(t.level||1){case 1:this.pdfService.addTitle(e,{align:((s=t.style)==null?void 0:s.align)||"center"});break;case 2:this.pdfService.addSubTitle(e,{align:((n=t.style)==null?void 0:n.align)||"left"});break;default:this.pdfService.addText(e,null,null,{fontSize:14,fontStyle:"bold",align:((o=t.style)==null?void 0:o.align)||"left"})}}renderTable(t,i){var h,g,u;const e=t.rows||[];if(e.length===0)return;if(t.dataVar){const f=t.dataVar.replace(/\{\{|\}\}/g,""),p=i[f];if(Array.isArray(p)){this.renderDataTable(t,p);return}}t.y!==void 0&&this.pdfService.resetPosition(t.y);const r=[],s=t.style||{},n=(f,p,b)=>{if(!f)return{content:""};const m=f.cellStyle||{},y={halign:f.align||"left",valign:m.verticalAlign==="top"?"top":m.verticalAlign==="bottom"?"bottom":"middle"};if(m.backgroundColor&&(y.fillColor=this.parseColorToArray(m.backgroundColor)),m.borderColor&&(y.lineColor=this.parseColorToArray(m.borderColor)),m.borderWidth&&(y.lineWidth=m.borderWidth),m.padding&&(y.cellPadding=m.padding),f.type==="image")return r.push({rowIndex:p,cellIndex:b,src:f.src,width:f.width,height:f.height}),{content:"[IMG]",colSpan:f.colSpan||1,rowSpan:f.rowSpan||1,styles:y};const T=typeof f=="object"?this.replaceVariables(f.content,i):f;return{content:this.cleanContent(T),colSpan:f.colSpan||1,rowSpan:f.rowSpan||1,styles:y}},o=((h=e[0])==null?void 0:h.map((f,p)=>n(f,0,p)))||[],a=(g=e[0])==null?void 0:g[0],l=(u=a==null?void 0:a.cellStyle)==null?void 0:u.backgroundColor,c=e.slice(1).map((f,p)=>f.map((b,m)=>n(b,p+1,m))),d={tableWidth:t.width};s.borderWidth!==void 0&&(d.lineWidth=s.borderWidth),s.borderColor&&(d.lineColor=this.parseColorToArray(s.borderColor)),s.backgroundColor&&(d.fillColor=this.parseColorToArray(s.backgroundColor)),s.align==="center"?d.tableAlign="center":s.align==="right"&&(d.tableAlign="right"),l&&(d.headStyles={fillColor:this.parseColorToArray(l)}),typeof this.pdfService.addTable=="function"?this.pdfService.addTable(o,c,d):this.drawTableManually(t,i)}parseColorToArray(t){if(!t)return[0,0,0];if(t.startsWith("#")){const e=t.slice(1),r=parseInt(e.substr(0,2),16),s=parseInt(e.substr(2,2),16),n=parseInt(e.substr(4,2),16);return[r,s,n]}const i=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return i?[parseInt(i[1]),parseInt(i[2]),parseInt(i[3])]:[0,0,0]}renderDataTable(t,i){const e=t.columns||[];if(e.length===0||!Array.isArray(i))return;const r=e.map(n=>n.label||n),s=i.map(n=>e.map(o=>{const a=o.key||o;return String(n[a]||"")}));typeof this.pdfService.addTable=="function"&&this.pdfService.addTable(r,s,t.style||{})}drawTableManually(t,i){var d;const e=t.rows||[],r=t.x||this.pdfService.margins.left,s=t.width||this.pdfService.pageWidth-r-this.pdfService.margins.right,n=t.rowHeight||8,o=((d=e[0])==null?void 0:d.length)||1,a=s/o,l=this.pdfService.doc;let c=this.pdfService.getCurrentY();l.setLineWidth(.5),l.setFontSize(10),e.forEach((h,g)=>{h.forEach((u,f)=>{const p=r+f*a,b=typeof u=="object"?this.replaceVariables(u.content,i):this.replaceVariables(String(u),i),m=typeof u=="object"?u.isHeader:g===0;m&&(l.setFillColor(240,240,240),l.rect(p,c,a,n,"F")),l.setDrawColor(0,0,0),l.rect(p,c,a,n);try{l.setFont("Roboto",m?"bold":"normal")}catch{l.setFont("helvetica",m?"bold":"normal")}l.setTextColor(0,0,0);const y=b.replace(/<[^>]*>/g,""),T=c+n/2+2;l.text(y,p+2,T,{maxWidth:a-4})}),c+=n}),this.pdfService.resetPosition(c+5)}renderImage(t,i){let e=this.replaceVariables(t.src,i);if(e&&(e.startsWith("data:")||e.startsWith("http"))){const r=t.x!==void 0?t.x:this.margins.left;this.pdfService.addImage(e,r,null,t.width||50,t.height||50,t.style||{})}}renderLine(t){if(t.fullWidth){const i=this.pdfService.getCurrentY();this.pdfService.addLine(this.margins.left,i,this.pageWidth-this.margins.right,i,t.style||{}),this.pdfService.addSpace(5)}else this.pdfService.addLine(t.x1,t.y1,t.x2,t.y2,t.style||{})}replaceVariables(t,i){return C.process(t,i)}processLayoutMarkers(t,i={}){if(!t||typeof t!="string")return t||"";let e=t.replace(/___TAB___/g,"    ");const r=e.includes("___BR___"),s=e.includes("___HR___"),n=e.includes("___PAGEBREAK___");if(!r&&!s&&!n)return e;const o=e.split(/(___BR___|___HR___|___PAGEBREAK___)/);for(let a=0;a<o.length;a++){const l=o[a];l==="___BR___"?this.pdfService.addSpace(i.lineHeight||5):l==="___HR___"?this.pdfService.addHorizontalLine():l==="___PAGEBREAK___"?this.pdfService.addNewPage():l.trim()}return e.replace(/___BR___|___HR___|___PAGEBREAK___/g,"")}hasLayoutMarkers(t){return t?t.includes("___BR___")||t.includes("___HR___")||t.includes("___PAGEBREAK___"):!1}renderTextWithMarkers(t,i={}){if(!t)return;const r=t.replace(/___TAB___/g,"    ").split(/(___BR___|___HR___|___PAGEBREAK___)/),s=i.x||this.margins.left,n=i.fontSize||12,o=i.lineHeight||n*.5;for(const a of r)a==="___BR___"?this.pdfService.addSpace(o):a==="___HR___"?this.pdfService.addHorizontalLine?this.pdfService.addHorizontalLine():this.pdfService.addSpace(5):a==="___PAGEBREAK___"?this.pdfService.addNewPage():a.trim()&&this.pdfService.addText(a.trim(),s,null,{fontSize:n,maxWidth:i.maxWidth||this.contentWidth,align:i.align||"left",color:i.color})}mapFontStyle(t){return t.fontWeight==="bold"&&t.fontStyle==="italic"?"bolditalic":t.fontWeight==="bold"?"bold":t.fontStyle==="italic"?"italic":"normal"}parseColor(t){if(!t)return[0,0,0];if(Array.isArray(t))return t;if(typeof t=="string"&&t.startsWith("#")){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(i)return[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16)]}if(typeof t=="string"&&t.startsWith("rgb")){const i=t.match(/(\d+),\s*(\d+),\s*(\d+)/);if(i)return[parseInt(i[1]),parseInt(i[2]),parseInt(i[3])]}return[0,0,0]}getDataUrl(){return this.pdfService.generateDataURL()}download(t="document.pdf"){this.pdfService.savePDF(t)}getBlob(){return this.pdfService.generateBlob()}preview(){this.pdfService.previewPDF()}renderEvalBlock(t,i){let e=t.code||"";e=e.replace(/^\/\/\s*eval\s*/i,""),e=e.replace(/^\/\*\s*eval\s*\*\/\s*/i,""),console.log("[PDFRenderer] Evaluating code block with full PDF access...");try{const r={pdf:this.pdfService,data:i,renderer:this,formatNumber:o=>C.formatNumber(o),formatCurrency:o=>C.formatCurrency(o),formatDate:o=>C.formatDate(o),today:()=>C.formatDateObject(new Date),now:()=>new Date().toLocaleString("vi-VN"),year:()=>new Date().getFullYear(),sum:(o,a)=>o.reduce((l,c)=>l+(Number(c[a])||0),0),count:o=>Array.isArray(o)?o.length:0,filter:(o,a)=>o.filter(a),map:(o,a)=>o.map(a),join:(o,a=", ")=>o.join(a),addText:(o,a,l,c)=>this.pdfService.addText(o,a,l,c),addTitle:(o,a)=>this.pdfService.addTitle(o,a),addTable:(o,a,l)=>this.pdfService.addTable(o,a,l),addSpace:o=>this.pdfService.addSpace(o),addLine:()=>this.pdfService.addHorizontalLine(),addImage:(o,a,l,c,d)=>this.pdfService.addImage(o,a,l,c,d),newPage:()=>this.pdfService.addNewPage()},n=new Function(...Object.keys(r),`
        "use strict";
        ${e}
      `)(...Object.values(r));console.log("[PDFRenderer] Eval completed, result:",n),typeof n=="string"&&n.trim()&&this.pdfService.addText(n,this.margins.left,null,{fontSize:12,maxWidth:this.contentWidth})}catch(r){console.error("[PDFRenderer] Eval error:",r),this.pdfService.addText(`[Eval Error: ${r.message}]`,this.margins.left,null,{fontSize:10,color:[255,0,0]})}}renderCodeBlock(t,i){const e=t.code||"",r=t.language||"text";console.log("[PDFRenderer] Rendering code block:",r,e.length,"chars"),this.pdfService.addText(e,this.margins.left,null,{fontSize:10,fontStyle:"normal",maxWidth:this.contentWidth})}}class z{constructor(){this.editor=null,this.parser=new I,this.renderer=new E,this.blueprint=null,this._initialized=!1}async init(t,i={}){var o,a,l,c,d;const e=typeof t=="string"?document.querySelector(t):t;if(!e)throw new Error(`DrawPDF: Element not found: ${t}`);const r=((o=window.CKEDITOR)==null?void 0:o.DecoupledEditor)||((a=window.CKEDITOR)==null?void 0:a.ClassicEditor)||window.DecoupledEditor||window.ClassicEditor;if(!r)throw new Error("DrawPDF: CKEditor not loaded. Please include CKEditor script before using DrawPDF.");const n={...{toolbar:{items:["undo","redo","|","findAndReplace","|","heading","|","bold","italic","underline","strikethrough","subscript","superscript","code","removeFormat","|","fontFamily","fontSize","fontColor","fontBackgroundColor","highlight","|","alignment","|","bulletedList","numberedList","todoList","|","outdent","indent","|","link","uploadImage","insertTable","blockQuote","codeBlock","|","horizontalLine","pageBreak","specialCharacters","|","sourceEditing"],shouldNotGroupWhenFull:!0},heading:{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h1",title:"Heading 1"},{model:"heading2",view:"h2",title:"Heading 2"},{model:"heading3",view:"h3",title:"Heading 3"},{model:"heading4",view:"h4",title:"Heading 4"},{model:"heading5",view:"h5",title:"Heading 5"},{model:"heading6",view:"h6",title:"Heading 6"}]},fontSize:{options:[10,11,12,13,14,16,18,20,22,24,26,28,32,36,42,48,72],supportAllValues:!0},fontFamily:{options:["default","Roboto, sans-serif","Times New Roman, Times, serif","Arial, Helvetica, sans-serif","Georgia, serif","Verdana, Geneva, sans-serif","Courier New, Courier, monospace","Tahoma, Geneva, sans-serif","Trebuchet MS, sans-serif"],supportAllValues:!0},fontColor:{colors:[{color:"#000000",label:"Black"},{color:"#4d4d4d",label:"Dark Gray"},{color:"#999999",label:"Gray"},{color:"#e6e6e6",label:"Light Gray"},{color:"#ffffff",label:"White"},{color:"#e64c4c",label:"Red"},{color:"#e6994c",label:"Orange"},{color:"#e6e64c",label:"Yellow"},{color:"#4ce64c",label:"Green"},{color:"#4c4ce6",label:"Blue"},{color:"#994ce6",label:"Purple"}]},table:{contentToolbar:["tableColumn","tableRow","mergeTableCells","tableProperties","tableCellProperties"]},image:{toolbar:["imageTextAlternative","toggleImageCaption","imageStyle:inline","imageStyle:block","imageStyle:side","linkImage"]},link:{addTargetToExternalLinks:!0,defaultProtocol:"https://"},language:"vi",removePlugins:["CKBox","CKFinder","EasyImage","RealTimeCollaborativeComments","RealTimeCollaborativeTrackChanges","RealTimeCollaborativeRevisionHistory","PresenceList","Comments","TrackChanges","TrackChangesData","RevisionHistory","Pagination","WProofreader","MathType","SlashCommand","Template","DocumentOutline","FormatPainter","TableOfContents","PasteFromOfficeEnhanced","CaseChange","AIAssistant","AI","MultiLevelList","RestrictedEditingMode","StandardEditingMode"]},...i};try{if(this.editor=await r.create(e,n),(d=(c=(l=this.editor.ui)==null?void 0:l.view)==null?void 0:c.toolbar)!=null&&d.element)if(i.toolbarContainer){const h=typeof i.toolbarContainer=="string"?document.querySelector(i.toolbarContainer):i.toolbarContainer;h&&h.appendChild(this.editor.ui.view.toolbar.element)}else e instanceof HTMLElement&&e.parentNode&&e.parentNode.insertBefore(this.editor.ui.view.toolbar.element,e);this._initialized=!0,console.log("✅ DrawPDF initialized")}catch(h){throw console.error("DrawPDF init failed:",h),h}return this}getData(){if(!this._initialized)throw new Error("DrawPDF: Not initialized. Call init() first.");const t=this.editor.getData();return this.blueprint=this.parser.parse(t),this.blueprint.sourceHtml=t,this.blueprint.createdAt=new Date().toISOString(),this.blueprint}setData(t){if(!t||typeof t!="object")throw new Error("DrawPDF: setData expects a JSON Blueprint object.");return this.blueprint=t,this._initialized&&t.sourceHtml&&this.editor.setData(t.sourceHtml),this}render(t={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint. Call getData() or setData() first.");return this.renderer.render(this.blueprint,t),this.renderer.getDataUrl()}download(t="document.pdf",i={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint. Call getData() or setData() first.");return this.renderer.render(this.blueprint,i),this.renderer.download(t),this}getBlob(t={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint.");return this.renderer.render(this.blueprint,t),this.renderer.getBlob()}preview(t={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint.");this.renderer.render(this.blueprint,t),this.renderer.preview()}getBlueprint(){return this.blueprint}exportJson(){if(!this.blueprint)throw new Error("DrawPDF: No blueprint to export.");return JSON.stringify(this.blueprint,null,2)}importJson(t){const i=JSON.parse(t);return this.setData(i)}destroy(){this.editor&&(this.editor.destroy(),this.editor=null,this._initialized=!1),this.blueprint=null}static async create(t,i={}){const e=new z;return await e.init(t,i),e}static parseHtml(t){const e=new I().parse(t);return e.sourceHtml=t,e.createdAt=new Date().toISOString(),e}static renderBlueprint(t,i={}){const e=new E;return e.render(t,i),e.getDataUrl()}static downloadBlueprint(t,i="document.pdf",e={}){const r=new E;r.render(t,e),r.download(i)}}const L="2.1.0";S.CKEditorParser=I,S.DrawPDF=z,S.FONTS=x,S.JsPdfService=v,S.PAGE=_,S.PDFRenderer=E,S.RichTextTokenizer=H,S.TemplateEngine=C,S.VERSION=L,S.default=z,Object.defineProperties(S,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
