(function(b,x){typeof exports=="object"&&typeof module<"u"?x(exports,require("jspdf"),require("jspdf-autotable")):typeof define=="function"&&define.amd?define(["exports","jspdf","jspdf-autotable"],x):(b=typeof globalThis<"u"?globalThis:b||self,x(b.DrawPDF={},b.jspdf,b.jspdfAutoTable))})(this,function(b,x,w){"use strict";var G=Object.defineProperty;var X=(b,x,w)=>x in b?G(b,x,{enumerable:!0,configurable:!0,writable:!0,value:w}):b[x]=w;var Y=(b,x,w)=>X(b,typeof x!="symbol"?x+"":x,w);class A{constructor(){this.inlineTags=["b","strong","i","em","u","s","strike","span"]}tokenize(t){if(!t||typeof t!="string")return[{text:"",style:this.createDefaultStyle()}];const i=document.createElement("div");i.innerHTML=t;const e=[];return this.walkTree(i,this.createDefaultStyle(),e),this.mergeSegments(e)}createDefaultStyle(){return{bold:!1,italic:!1,underline:!1,strikethrough:!1,color:null,backgroundColor:null,fontSize:null}}decodeHtmlEntities(t){if(!t||typeof t!="string")return t;const i={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&apos;":"'","&ndash;":"–","&mdash;":"—","&hellip;":"…","&copy;":"©","&reg;":"®","&trade;":"™","&deg;":"°","&plusmn;":"±","&times;":"×","&divide;":"÷"};let e=t;for(const[n,o]of Object.entries(i))e=e.split(n).join(o);return e=e.replace(/&#(\d+);/g,(n,o)=>String.fromCharCode(o)),e=e.replace(/&#x([0-9a-fA-F]+);/g,(n,o)=>String.fromCharCode(parseInt(o,16))),e=e.replace(/\u00A0/g," "),e}walkTree(t,i,e){const n=t.childNodes;for(let o=0;o<n.length;o++){const s=n[o];if(s.nodeType===Node.TEXT_NODE){let r=s.textContent;r=this.decodeHtmlEntities(r),r&&e.push({text:r,style:{...i}})}else if(s.nodeType===Node.ELEMENT_NODE){const r=this.applyNodeStyle(s,i);this.walkTree(s,r,e)}}}applyNodeStyle(t,i){const e={...i};switch(t.tagName.toLowerCase()){case"b":case"strong":e.bold=!0;break;case"i":case"em":e.italic=!0;break;case"u":e.underline=!0;break;case"s":case"strike":case"del":e.strikethrough=!0;break}return t.style&&((t.style.fontWeight==="bold"||parseInt(t.style.fontWeight)>=700)&&(e.bold=!0),t.style.fontStyle==="italic"&&(e.italic=!0),t.style.textDecoration&&(t.style.textDecoration.includes("underline")&&(e.underline=!0),t.style.textDecoration.includes("line-through")&&(e.strikethrough=!0)),t.style.color&&(e.color=this.parseColor(t.style.color)),t.style.backgroundColor&&(e.backgroundColor=this.parseColor(t.style.backgroundColor)),t.style.fontSize&&(e.fontSize=this.parseFontSize(t.style.fontSize))),e}parseColor(t){if(!t)return null;if(t.startsWith("#"))return t;const i=t.match(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);if(i){const n=parseInt(i[1]),o=parseInt(i[2]),s=parseInt(i[3]);return[n,o,s]}const e=t.match(/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*[\d.]+\s*\)/i);if(e){const n=parseInt(e[1]),o=parseInt(e[2]),s=parseInt(e[3]);return[n,o,s]}return null}parseFontSize(t){if(!t)return null;const i=t.match(/(\d+(?:\.\d+)?)\s*px/i);if(i)return Math.round(parseFloat(i[1])*.75);const e=t.match(/(\d+(?:\.\d+)?)\s*pt/i);if(e)return parseFloat(e[1]);const n=t.match(/^(\d+(?:\.\d+)?)$/);return n?parseFloat(n[1]):null}mergeSegments(t){if(t.length===0)return t;const i=[];let e={...t[0]};for(let n=1;n<t.length;n++){const o=t[n];this.stylesEqual(e.style,o.style)?e.text+=o.text:(e.text&&i.push(e),e={...o})}return e.text&&i.push(e),i}stylesEqual(t,i){return t.bold===i.bold&&t.italic===i.italic&&t.underline===i.underline&&t.strikethrough===i.strikethrough&&this.colorsEqual(t.color,i.color)&&t.fontSize===i.fontSize}colorsEqual(t,i){return t===i?!0:!t||!i?!1:Array.isArray(t)&&Array.isArray(i)?t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]:!1}}const T={WIDTH:210,HEIGHT:297,MARGIN_TOP:20,MARGIN_BOTTOM:20,MARGIN_LEFT:15,MARGIN_RIGHT:15,get CONTENT_WIDTH(){return this.WIDTH-this.MARGIN_LEFT-this.MARGIN_RIGHT},get CONTENT_HEIGHT(){return this.HEIGHT-this.MARGIN_TOP-this.MARGIN_BOTTOM}},C={DEFAULT_SIZE:12,LINE_HEIGHT:1.5,H1_SIZE:18,H2_SIZE:16,H3_SIZE:14};class N{constructor(){this.currentY=T.MARGIN_TOP,this.currentPage=0,this.pages=[{pageNumber:1,elements:[]}],this.tokenizer=new A}decodeHtmlEntities(t){if(!t||typeof t!="string")return t;const i={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&apos;":"'","&ndash;":"–","&mdash;":"—","&hellip;":"…"};let e=t;for(const[n,o]of Object.entries(i))e=e.split(n).join(o);return e=e.replace(/&#(\d+);/g,(n,o)=>String.fromCharCode(o)),e=e.replace(/&#x([0-9a-fA-F]+);/g,(n,o)=>String.fromCharCode(parseInt(o,16))),e=e.replace(/\u00A0/g," "),e}parse(t){this.currentY=T.MARGIN_TOP,this.currentPage=0,this.pages=[{pageNumber:1,elements:[]}];const n=new DOMParser().parseFromString(t,"text/html").body.children;for(let o=0;o<n.length;o++)this.processNode(n[o]);return{version:"1.0",pageSize:{width:T.WIDTH,height:T.HEIGHT,unit:"mm"},margins:{top:T.MARGIN_TOP,bottom:T.MARGIN_BOTTOM,left:T.MARGIN_LEFT,right:T.MARGIN_RIGHT},pages:this.pages}}processNode(t){var e,n;switch((e=t.tagName)==null?void 0:e.toLowerCase()){case"p":this.processParagraph(t);break;case"h1":this.processHeading(t,1);break;case"h2":this.processHeading(t,2);break;case"h3":this.processHeading(t,3);break;case"ul":this.processList(t,"bullet");break;case"ol":this.processList(t,"number");break;case"table":this.processTable(t);break;case"figure":t.querySelector("table")?this.processTable(t.querySelector("table")):t.querySelector("img")&&this.processImage(t.querySelector("img"));break;case"hr":this.processHorizontalRule();break;case"pre":this.processCodeBlock(t);break;default:(n=t.textContent)!=null&&n.trim()&&this.addTextElement(t.textContent.trim(),{})}}processParagraph(t){const i=t.innerHTML,e=this.extractStyles(t),n=t.style.textAlign||"left";this.addTextElement(i,{...e,align:n})}processHeading(t,i){const e=t.innerHTML,n={1:C.H1_SIZE,2:C.H2_SIZE,3:C.H3_SIZE};this.addTextElement(e,{fontSize:n[i],fontWeight:"bold",align:t.style.textAlign||"left"})}processList(t,i){t.querySelectorAll("li").forEach((n,o)=>{const r=(i==="number"?`${o+1}. `:"• ")+n.innerHTML;this.addTextElement(r,{indent:10})})}processTable(t){const i=[],e=t.querySelectorAll("tr"),n={width:this.parseWidth(t.style.width||t.getAttribute("width")),borderWidth:this.parseBorderWidth(t.style.border||t.getAttribute("border")),borderColor:this.parseColor(t.style.borderColor)||"#000000",backgroundColor:this.parseColor(t.style.backgroundColor),align:this.parseTableAlign(t)};e.forEach(o=>{const s=[];o.querySelectorAll("td, th").forEach(a=>{const l=a.querySelector("img"),c=parseInt(a.getAttribute("colspan"))||1,d=parseInt(a.getAttribute("rowspan"))||1;let h=a.style.textAlign||"left";const g=a.querySelector('p[style*="text-align"]');g&&g.style.textAlign&&(h=g.style.textAlign);const u={backgroundColor:this.parseColor(a.style.backgroundColor),borderColor:this.parseColor(a.style.borderColor),borderWidth:this.parseBorderWidth(a.style.border||a.style.borderWidth),verticalAlign:a.style.verticalAlign||"middle",padding:this.parsePadding(a.style.padding),width:this.parseWidth(a.style.width||a.getAttribute("width")),height:this.parseWidth(a.style.height||a.getAttribute("height"))};l?s.push({type:"image",src:l.src||l.getAttribute("src"),width:parseInt(l.width)||50,height:parseInt(l.height)||50,colSpan:c,rowSpan:d,align:h,isHeader:a.tagName.toLowerCase()==="th",cellStyle:u}):s.push({content:a.innerHTML||" ",isHeader:a.tagName.toLowerCase()==="th",colSpan:c,rowSpan:d,align:h,cellStyle:u})}),i.push(s)}),this.addElement({type:"table",width:n.width||T.CONTENT_WIDTH,rows:i,style:n})}parseWidth(t){if(!t)return null;const i=parseFloat(t);return isNaN(i)?null:String(t).includes("%")?i/100*T.CONTENT_WIDTH:String(t).includes("px")?i*.264:i}parseBorderWidth(t){if(!t)return .5;const i=String(t).match(/(\d+\.?\d*)/);if(i){const e=parseFloat(i[1]);return e>5?e*.264:e}return .5}parseColor(t){if(!t)return null;if(t.startsWith("#"))return t;const i=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(i){const e=parseInt(i[1]).toString(16).padStart(2,"0"),n=parseInt(i[2]).toString(16).padStart(2,"0"),o=parseInt(i[3]).toString(16).padStart(2,"0");return`#${e}${n}${o}`}return t}parseTableAlign(t){const i=t.style.marginLeft,e=t.style.marginRight;return i==="auto"&&e==="auto"?"center":i==="auto"?"right":"left"}parsePadding(t){if(!t)return null;const i=parseFloat(t);return isNaN(i)?null:i*.264}processImage(t){const i=t.src||t.getAttribute("src"),e=parseInt(t.width)||50,n=parseInt(t.height)||50,o=Math.min(e*.264,T.CONTENT_WIDTH),s=n*.264;this.addElement({type:"image",width:o,height:s,src:i,align:"left"})}processHorizontalRule(){this.addElement({type:"line",fullWidth:!0,style:{color:"#cccccc",width:.5}})}extractStyles(t){var l,c,d,h;const i={},e=t.innerHTML;(e.includes("<strong>")||e.includes("<b>")||t.style.fontWeight==="bold")&&(i.fontWeight="bold"),(e.includes("<i>")||e.includes("<em>")||t.style.fontStyle==="italic")&&(i.fontStyle="italic"),(e.includes("<u>")||(l=t.style.textDecoration)!=null&&l.includes("underline"))&&(i.underline=!0);const n=e.match(/color:\s*([^;"]+)/);n&&(i.color=n[1]);const o=e.match(/font-size:\s*(\d+)/);o&&(i.fontSize=parseInt(o[1]));const s=(c=t.style.marginLeft)==null?void 0:c.match(/(\d+)/);s&&(i.marginLeft=parseFloat(s[1])*.264);const r=(d=t.style.textIndent)==null?void 0:d.match(/(\d+)/);r&&(i.indent=parseFloat(r[1])*.264);const a=(h=t.style.paddingLeft)==null?void 0:h.match(/(\d+)/);return a&&(i.indent=(i.indent||0)+parseFloat(a[1])*.264),i}addTextElement(t,i){const e=this.tokenizer.tokenize(t),n=e.map(l=>l.text).join("");if(!n.trim()){this.addElement({type:"space",height:(i.fontSize||C.DEFAULT_SIZE)*C.LINE_HEIGHT*.352778});return}const o=i.fontSize||C.DEFAULT_SIZE,s=o*C.LINE_HEIGHT*.352778,r=(i.indent||0)+(i.marginLeft||0),a=T.CONTENT_WIDTH-r;this.addElement({type:"richtext",indent:i.indent||0,marginLeft:i.marginLeft||0,width:a,segments:e,content:n,style:{fontSize:o,fontWeight:i.fontWeight||"normal",fontStyle:i.fontStyle||"normal",color:i.color||"#000000",align:i.align||"left",underline:i.underline||!1,lineHeight:s}})}addElement(t){this.pages[this.currentPage].elements.push(t)}newPage(){this.currentPage++,this.pages.push({pageNumber:this.currentPage+1,elements:[]}),this.currentY=T.MARGIN_TOP}processCodeBlock(t){const i=t.querySelector("code")||t;let e=i.textContent||"";e=this.decodeHtmlEntities(e);const n=e.trim().startsWith("// eval")||e.trim().startsWith("/* eval */")||e.trim().startsWith("//eval"),s=(i.className||"").match(/language-(\w+)/),r=s?s[1]:"javascript",a={type:n?"evalblock":"codeblock",code:e.trim(),language:r,isEval:n};this.addElement(a),console.log("[CKEditorParser] Code block:",n?"EVAL":"DISPLAY",r)}}class P{static getNestedValue(t,i){if(!t||!i)return;const e=i.trim().split(".");let n=t;for(const o of e){if(n==null)return;n=n[o]}return n}static evaluateCondition(t,i){const e=t.trim(),n=["===","!==",">=","<=",">","<"];for(const s of n)if(e.includes(s)){const[r,a]=e.split(s).map(d=>d.trim()),l=this.resolveValue(r,i),c=this.resolveValue(a,i);switch(s){case"===":return l===c;case"!==":return l!==c;case">":return l>c;case"<":return l<c;case">=":return l>=c;case"<=":return l<=c}}return!!this.resolveValue(e,i)}static resolveValue(t,i){const e=t.trim();if(e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"'))return e.slice(1,-1);if(!isNaN(e)&&e!=="")return parseFloat(e);if(e==="true")return!0;if(e==="false")return!1;if(e==="null")return null;if(e!=="undefined")return this.getNestedValue(i,e)}static processIfBlocks(t,i){const e=/\{\{#if\s+([^}]+)\}\}([\s\S]*?)\{\{\/if\}\}/g;return t.replace(e,(n,o,s)=>{const r=this.evaluateCondition(o,i),a=s.indexOf("{{else}}");if(a!==-1){const l=s.substring(0,a),c=s.substring(a+8);return r?l:c}return r?s:""})}static processEachBlocks(t,i){const e=/\{\{~?#each\s+([^}~]+)~?\}\}([\s\S]*?)\{\{~?\/each~?\}\}/g;return t.replace(e,(n,o,s)=>{const r=o.trim(),a=this.getNestedValue(i,r);if(console.log("[TemplateEngine] #each:",r,"array:",a),!Array.isArray(a)||a.length===0)return console.log("[TemplateEngine] #each: array not found or empty"),"";const l=s.trim();return a.map((c,d)=>{const h={...i,...c,"@index":d,"@first":d===0,"@last":d===a.length-1,"@item":c};let g=this.processIfBlocks(l,h);return g=this.processFormatHelpers(g,h),g=this.processDateHelpers(g),g=this.replaceVariables(g,h),g=this.processLayoutTags(g),g.trim()}).join(`
`)})}static processLayoutTags(t){let i=t;return i=i.replace(/\{\{br\}\}/gi,"___BR___"),i=i.replace(/\{\{tab\}\}/gi,"___TAB___"),i=i.replace(/\{\{space\}\}/gi," "),i=i.replace(/\{\{hr\}\}/gi,"___HR___"),i=i.replace(/\{\{pageBreak\}\}/gi,"___PAGEBREAK___"),i}static processFormatHelpers(t,i){let e=t;return e=e.replace(/\{\{formatNumber\s+([^}]+)\}\}/g,(n,o)=>{const s=this.getNestedValue(i,o.trim());return s==null?n:this.formatNumber(s)}),e=e.replace(/\{\{formatCurrency\s+([^}]+)\}\}/g,(n,o)=>{const s=this.getNestedValue(i,o.trim());return s==null?n:this.formatCurrency(s)}),e=e.replace(/\{\{formatDate\s+([^}]+)\}\}/g,(n,o)=>{const s=this.getNestedValue(i,o.trim());return s==null?n:this.formatDate(s)}),e=e.replace(/\{\{uppercase\s+([^}]+)\}\}/g,(n,o)=>{const s=this.getNestedValue(i,o.trim());return s==null?n:String(s).toUpperCase()}),e=e.replace(/\{\{lowercase\s+([^}]+)\}\}/g,(n,o)=>{const s=this.getNestedValue(i,o.trim());return s==null?n:String(s).toLowerCase()}),e=e.replace(/\{\{capitalize\s+([^}]+)\}\}/g,(n,o)=>{const s=this.getNestedValue(i,o.trim());return s==null?n:String(s).replace(/\b\w/g,r=>r.toUpperCase())}),e}static processDateHelpers(t){const i=new Date;let e=t;return e=e.replace(/\{\{now\}\}/gi,i.toLocaleString("vi-VN")),e=e.replace(/\{\{today\}\}/gi,this.formatDateObject(i)),e=e.replace(/\{\{year\}\}/gi,String(i.getFullYear())),e=e.replace(/\{\{month\}\}/gi,String(i.getMonth()+1).padStart(2,"0")),e=e.replace(/\{\{day\}\}/gi,String(i.getDate()).padStart(2,"0")),e=e.replace(/\{\{time\}\}/gi,`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}`),e}static formatNumber(t){if(t==null||t==="")return"";const i=parseFloat(t);return isNaN(i)?"":i.toLocaleString("vi-VN")}static formatCurrency(t){if(t==null||t==="")return"";const i=parseFloat(t);return isNaN(i)?"":i.toLocaleString("vi-VN")+"đ"}static formatDate(t){if(!t)return"";if(typeof t=="string"&&/^\d{2}\/\d{2}\/\d{4}$/.test(t))return t;const i=new Date(t);return isNaN(i.getTime())?String(t):this.formatDateObject(i)}static formatDateObject(t){const i=String(t.getDate()).padStart(2,"0"),e=String(t.getMonth()+1).padStart(2,"0"),n=t.getFullYear();return`${i}/${e}/${n}`}static replaceVariables(t,i){return!t||typeof t!="string"?t||"":t.replace(/\{\{([^#\/][^}]*?)\}\}/g,(e,n)=>{const o=n.trim();if(["br","tab","space","hr","pageBreak","now","today","year","month","day","time"].includes(o.toLowerCase())||o.startsWith("formatNumber")||o.startsWith("formatCurrency")||o.startsWith("formatDate")||o.startsWith("uppercase")||o.startsWith("lowercase")||o.startsWith("capitalize"))return e;if(o.startsWith("@")){const a=i[o];return a!==void 0?String(a):e}const r=this.getNestedValue(i,o);return r!==void 0?String(r):e})}static process(t,i){if(!t||typeof t!="string")return t||"";let e=t;return e=this.processIfBlocks(e,i),e=this.processEachBlocks(e,i),e=this.processFormatHelpers(e,i),e=this.processDateHelpers(e),e=this.replaceVariables(e,i),e=this.processLayoutTags(e),e}static extractVariables(t){if(!t||typeof t!="string")return[];const i=new Set,e=["br","tab","space","hr","pageBreak","now","today","year","month","day","time","else"],n=/\{\{([^#\/][^}]*?)\}\}/g;let o;for(;(o=n.exec(t))!==null;){const a=o[1].trim();if(!a.startsWith("@")&&!e.includes(a.toLowerCase())){if(a.startsWith("formatNumber ")||a.startsWith("formatCurrency ")||a.startsWith("formatDate ")||a.startsWith("uppercase ")||a.startsWith("lowercase ")||a.startsWith("capitalize ")){const l=a.split(" ");l[1]&&i.add(l[1].trim());continue}i.add(a)}}const s=/\{\{#each\s+([^}]+)\}\}/g;for(;(o=s.exec(t))!==null;)i.add(o[1].trim());const r=/\{\{#if\s+([^}]+)\}\}/g;for(;(o=r.exec(t))!==null;)o[1].trim().split(/[=!<>]+/).map(c=>c.trim()).forEach(c=>{c&&!c.startsWith("'")&&!c.startsWith('"')&&isNaN(c)&&c!=="true"&&c!=="false"&&c!=="null"&&i.add(c)});return Array.from(i)}}const E={defaultFont:"Roboto",fallback:"helvetica",register:[]},{jsPDF:D}=window.jspdf;w.applyPlugin(D),typeof window<"u"&&!window.jspdf&&(window.jspdf={jsPDF:D});class L{constructor(t={}){const{defaultFont:i,fallback:e,register:n,format:o,orientation:s,unit:r,margins:a,...l}=t;this.fontConfig={...E,...i?{defaultFont:i}:{},...e?{fallback:e}:{},...n?{register:n}:{}},this.defaultFont=this.fontConfig.defaultFont,this.fallbackFont=this.fontConfig.fallback;const c={orientation:s||"portrait",unit:r||"mm",format:o||"a4"};this.doc=new D(c),this.pageHeight=this.doc.internal.pageSize.height,this.pageWidth=this.doc.internal.pageSize.width,this.margins={left:15,right:15,top:20,bottom:20},a&&(this.margins={...this.margins,...a}),this.currentY=this.margins.top,this.lineHeight=1,this._setupDefaultFont()}_setupDefaultFont(){try{const t=this.doc.getFontList();t[this.defaultFont]?this.doc.setFont(this.defaultFont,"normal"):t[this.fallbackFont]?(console.warn(`Font '${this.defaultFont}' not found, using fallback '${this.fallbackFont}'`),this.doc.setFont(this.fallbackFont,"normal"),this.defaultFont=this.fallbackFont):(console.warn(`Neither '${this.defaultFont}' nor '${this.fallbackFont}' found, using 'helvetica'`),this.doc.setFont("helvetica","normal"),this.defaultFont="helvetica")}catch(t){console.warn("Error setting up font, using helvetica:",t.message),this.doc.setFont("helvetica","normal"),this.defaultFont="helvetica"}}_setFont(t=null,i="normal"){const e=t||this.defaultFont;try{this.doc.setFont(e,i)}catch{try{this.doc.setFont(this.fallbackFont,i)}catch{this.doc.setFont("helvetica",i)}}}checkPageBreak(t=10){this.currentY+t>this.pageHeight-this.margins.bottom&&this.addNewPage()}_decodeHtmlEntities(t){if(!t||typeof t!="string")return t;let i=t.replace(/\u00A0/g," ");const e={"&nbsp;":" ","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&apos;":"'","&ndash;":"–","&mdash;":"—","&hellip;":"…","&copy;":"©","&reg;":"®","&trade;":"™","&deg;":"°","&plusmn;":"±","&times;":"×","&divide;":"÷","&cent;":"¢","&pound;":"£","&euro;":"€","&yen;":"¥","&sect;":"§","&bull;":"•"};for(const[n,o]of Object.entries(e))i=i.split(n).join(o);return i=i.replace(/&#(\d+);/g,(n,o)=>{const s=parseInt(o,10);return s===160?" ":String.fromCharCode(s)}),i=i.replace(/&#x([0-9a-fA-F]+);/g,(n,o)=>{const s=parseInt(o,16);return s===160?" ":String.fromCharCode(s)}),i=i.replace(/\u00A0/g," "),i}_drawText(t,i,e,n={}){const o=this._decodeHtmlEntities(t);this.doc.text(o,i,e,n)}_parseColorToArray(t){if(Array.isArray(t))return t;if(!t)return[0,0,0];if(typeof t=="string"&&t.startsWith("#")){let i=t.slice(1);i.length===3&&(i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]);const e=parseInt(i.substring(0,2),16)||0,n=parseInt(i.substring(2,4),16)||0,o=parseInt(i.substring(4,6),16)||0;return[e,n,o]}if(typeof t=="string"){const i=t.match(/rgb[a]?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(i)return[parseInt(i[1]),parseInt(i[2]),parseInt(i[3])]}return[0,0,0]}addText(t,i=null,e=null,n={}){t=this._decodeHtmlEntities(t);const s={...{fontSize:12,fontStyle:"normal",color:[0,0,0],maxWidth:this.pageWidth-this.margins.left-this.margins.right,align:"left",lineHeight:this.lineHeight},...n},r=i!==null?i:this.margins.left;e!==null||this.currentY,this.doc.setFontSize(s.fontSize),this._setFont(null,s.fontStyle),this.doc.setTextColor(s.color[0],s.color[1],s.color[2]);const a=this.doc.splitTextToSize(t,s.maxWidth),l=a.length*s.lineHeight;this.checkPageBreak(l+5);let c=this.currentY;a.forEach((h,g)=>{if(s.align==="center"){const u=this.doc.getTextWidth(h),f=(this.pageWidth-u)/2;this._drawText(h,f,c)}else if(s.align==="right"){const u=this.doc.getTextWidth(h),f=this.pageWidth-this.margins.right-u;this._drawText(h,f,c)}else s.align==="justify"?!(g===a.length-1)&&h.trim().length>0?this.drawJustifiedText(h,r,c,s.maxWidth,s):this._drawText(h,r,c):this._drawText(h,r,c);c+=s.lineHeight});const d=n.spacing!==void 0?n.spacing:1;return this.currentY=c+d,this}drawJustifiedText(t,i,e,n,o){const s=t.trim().split(" ");if(s.length<=1){this._drawText(t,i,e);return}let r=0;s.forEach(h=>{r+=this.doc.getTextWidth(h)});const a=s.length-1,c=(n-r)/a;let d=i;s.forEach((h,g)=>{this._drawText(h,d,e),d+=this.doc.getTextWidth(h),g<s.length-1&&(d+=c)})}addTable(t,i,e={}){if(!this.doc.autoTable)return console.warn("jspdf-autotable is not loaded"),this;const n=e.y!==void 0?e.y:this.currentY,o={font:this.defaultFont,fontSize:10,cellPadding:3,overflow:"linebreak"};e.lineWidth!==void 0&&(o.lineWidth=e.lineWidth),e.lineColor&&(o.lineColor=e.lineColor),e.fillColor&&(o.fillColor=e.fillColor);const s={...o,...e.styles||{}},r={fillColor:!1,textColor:[0,0,0],halign:"center",...e.headStyles||{}};let a={top:this.margins.top,right:this.margins.right,bottom:this.margins.bottom,left:this.margins.left};e.margin&&(a={...a,...e.margin});let l=e.tableWidth||"auto";if(e.tableAlign==="center"&&e.tableWidth){const F=(this.pageWidth-this.margins.left-this.margins.right-e.tableWidth)/2;a.left=this.margins.left+F}else if(e.tableAlign==="right"&&e.tableWidth){const F=this.pageWidth-this.margins.left-this.margins.right-e.tableWidth;a.left=this.margins.left+F}const{y:c,lineWidth:d,lineColor:h,fillColor:g,tableWidth:u,tableAlign:f,styles:p,headStyles:S,margin:m,...y}=e,_={startY:n,head:Array.isArray(t)&&t.length>0&&Array.isArray(t[0])?t:[t],body:i,theme:"grid",styles:s,headStyles:r,columnStyles:{},margin:a,tableWidth:typeof l=="number"?l:"auto",didDrawPage:W=>{this.currentY=W.cursor.y+5},...y};return this.doc.autoTable(_),this.doc.lastAutoTable&&(this.currentY=this.doc.lastAutoTable.finalY+10),this}addTitle(t,i={}){const e={fontSize:18,fontStyle:"bold",color:[0,0,0],align:"center",lineHeight:7,...i};return this.addText(t,null,null,e),this.currentY+=3,this}addSubTitle(t,i={}){const e={fontSize:14,fontStyle:"bold",color:[0,0,0],lineHeight:5.5,...i};return this.addText(t,null,null,e),this.currentY+=2,this}addParagraph(t,i={}){const e={fontSize:10,fontStyle:"normal",color:[0,0,0],lineHeight:4,spacing:1,...i};return this.addText(t,null,null,e),this}addBulletPoint(t,i={}){const e={fontSize:11,fontStyle:"normal",color:[0,0,0],lineHeight:4,...i};this.doc.setFontSize(e.fontSize),this._drawText("•",this.margins.left,this.currentY);const n=t,o={...e,maxWidth:e.maxWidth-10};return this.addText(n,this.margins.left+8,this.currentY,o),this}addImage(t,i=null,e=null,n=100,o=100,s={}){const r={format:"JPEG",align:"left",caption:null,captionOptions:{fontSize:9,fontStyle:"italic",color:[100,100,100]},border:!1,borderOptions:{width:1,color:[0,0,0]},compression:"MEDIUM",rotation:0,...s};let a=i!==null?i:this.margins.left;e!==null||this.currentY,r.align==="center"?a=(this.pageWidth-n)/2:r.align==="right"&&(a=this.pageWidth-this.margins.right-n),this.checkPageBreak(o+15);try{let l=r.format;if(typeof t=="string"&&t.startsWith("data:")&&(t.includes("data:image/png")?l="PNG":t.includes("data:image/jpeg")||t.includes("data:image/jpg")?l="JPEG":t.includes("data:image/gif")?l="GIF":t.includes("data:image/webp")&&(l="WEBP")),this.doc.addImage(t,l,a,this.currentY,n,o,"",r.compression,r.rotation),r.border){this.doc.setLineWidth(r.borderOptions.width);const c=Array.isArray(r.borderOptions.color)?r.borderOptions.color:[0,0,0];this.doc.setDrawColor(...c),this.doc.rect(a,this.currentY,n,o)}this.currentY+=o+5,r.caption?this.addText(r.caption,null,null,{...r.captionOptions,align:r.align}):this.currentY+=5}catch(l){console.error("Lỗi khi thêm ảnh:",l),this.addText(`[Lỗi hiển thị ảnh: ${l.message}]`,a,null,{fontSize:10,color:[255,0,0],align:r.align})}return this}async addImageFromPath(t,i=null,e=null,n=100,o=100,s={}){try{const r=await this.loadImageFromPath(t);if(r)return this.addImage(r,i,e,n,o,s);throw new Error(`Không thể load ảnh từ ${t}`)}catch(r){console.error("Lỗi khi thêm ảnh từ path:",r),this.addText(`[Không thể load ảnh: ${t}]`,i,e,{fontSize:10,color:[255,0,0]})}return this}addImageFit(t,i=null,e=null,n=150,o=150,s={}){return new Promise(r=>{const a=new Image;a.onload=()=>{let{width:l,height:c}=this.calculateFitSize(a.naturalWidth,a.naturalHeight,n,o);this.addImage(t,i,e,l,c,s),r(this)},a.onerror=()=>{console.error("Không thể load ảnh để tính kích thước"),this.addImage(t,i,e,n,o,s),r(this)},a.src=t})}calculateFitSize(t,i,e,n){const o=e/t,s=n/i,r=Math.min(o,s);return{width:t*r,height:i*r}}addLine(t=null,i=null,e=null,n=null,o={}){const s=t!==null?t:this.margins.left,r=i!==null?i:this.currentY,a=e!==null?e:this.pageWidth-this.margins.right,l=n!==null?n:r,c={lineWidth:.5,color:[0,0,0],...o};return this.doc.setLineWidth(c.lineWidth),this.doc.setDrawColor(c.color[0],c.color[1],c.color[2]),this.doc.line(s,r,a,l),this.currentY=r+8,this}addNewPage(){return this.doc.addPage(),this.currentY=this.margins.top,this._addSecondarySignaturesToNewPage(),this}addSpace(t=10){return this.currentY+=t,this.checkPageBreak(),this}addHorizontalLine(t={}){const i={width:t.width||this.pageWidth-this.margins.left-this.margins.right,thickness:t.thickness||.5,color:t.color||[0,0,0],marginTop:t.marginTop||3,marginBottom:t.marginBottom||3,...t};this.currentY+=i.marginTop,this.checkPageBreak(i.thickness+i.marginBottom);const e=this.margins.left,n=e+i.width;return this.doc.setDrawColor(...i.color),this.doc.setLineWidth(i.thickness),this.doc.line(e,this.currentY,n,this.currentY),this.currentY+=i.thickness+i.marginBottom,this}resetPosition(t=null){return this.currentY=t!==null?t:this.margins.top,this}getCurrentY(){return this.currentY}addHeader(t,i={}){const e={fontSize:10,fontStyle:"normal",align:"center",color:[0,0,0],y:10,...i},n=this.doc.internal.getNumberOfPages(),o=this.doc.internal.getCurrentPageInfo().pageNumber,s=this.doc.internal.getCurrentPageInfo().color||[0,0,0];for(let r=1;r<=n;r++){this.doc.setPage(r),this.doc.setFontSize(e.fontSize),this.doc.setTextColor(e.color[0],e.color[1],e.color[2]),this._setFont(null,e.fontStyle);let a;const l=this.doc.getTextWidth(t);e.align==="center"?a=(this.pageWidth-l)/2:e.align==="right"?a=this.pageWidth-this.margins.right-l:a=this.margins.left,this._drawText(t,a,e.y)}return this.doc.setTextColor(s[0]||0,s[1]||0,s[2]||0),this.doc.setPage(o),this}addFooter(t,i={}){const e={fontSize:8,fontStyle:"normal",align:"center",y:this.pageHeight-10,color:[0,0,0],...i},n=this.doc.internal.getNumberOfPages(),o=this.doc.internal.getCurrentPageInfo().pageNumber;for(let s=1;s<=n;s++){this.doc.setPage(s),this.doc.setFontSize(e.fontSize),this._setFont(null,e.fontStyle);const r=Array.isArray(e.color)?e.color:[0,0,0];this.doc.setTextColor(r[0],r[1],r[2]);const a=t.replace("{pageNumber}",s).replace("{totalPages}",n);if(e.align==="center"){const l=this.doc.getTextWidth(a),c=(this.pageWidth-l)/2;this._drawText(a,c,e.y)}else if(e.align==="right"){const l=this.doc.getTextWidth(a);this._drawText(a,this.pageWidth-this.margins.right-l,e.y)}else this._drawText(a,this.margins.left,e.y)}return this.doc.setPage(o),this}savePDF(t="document.pdf"){try{this.doc.save(t),console.log(`PDF đã được lưu: ${t}`)}catch(i){console.error("Lỗi khi lưu PDF:",i)}}generateBlob(){try{return this.doc.output("blob")}catch(t){return console.error("Lỗi khi tạo blob:",t),null}}generateDataURL(){try{return this.doc.output("dataurlstring")}catch(t){return console.error("Lỗi khi tạo data URL:",t),null}}previewPDF(){try{const t=this.doc.output("dataurlstring");window.open(t,"_blank")}catch(t){console.error("Lỗi khi preview PDF:",t)}}exportPDFFile(t="document.pdf"){try{const i=this.doc.output("blob"),e=new File([i],t,{type:"application/pdf",lastModified:Date.now()});return console.log(`PDF file đã được tạo: ${t}, Size: ${e.size} bytes`),e}catch(i){return console.error("Lỗi khi tạo PDF file:",i),null}}exportPDFArrayBuffer(){try{const t=this.doc.output("arraybuffer");return console.log(`PDF ArrayBuffer đã được tạo, Size: ${t.byteLength} bytes`),t}catch(t){return console.error("Lỗi khi tạo PDF ArrayBuffer:",t),null}}exportPDF(t="file",i="document.pdf"){try{switch(t.toLowerCase()){case"file":return this.exportPDFFile(i);case"blob":return this.generateBlob();case"arraybuffer":return this.exportPDFArrayBuffer();case"dataurl":return this.generateDataURL();case"base64":return this.doc.output("datauristring").split(",")[1];case"binarystring":return this.doc.output("binarystring");default:return console.warn(`Format không hỗ trợ: ${t}. Sử dụng format 'file' mặc định.`),this.exportPDFFile(i)}}catch(e){return console.error(`Lỗi khi export PDF với format ${t}:`,e),null}}async uploadPDFToServer(t,i="document.pdf",e={}){try{const n=this.exportPDFFile(i);if(!n)throw new Error("Không thể tạo PDF file");const o=new FormData;o.append(e.fieldName||"pdf",n),e.additionalData&&Object.keys(e.additionalData).forEach(l=>{o.append(l,e.additionalData[l])});const s={method:"POST",body:o,...e.fetchOptions};console.log(`Đang upload PDF tới: ${t}`);const r=await fetch(t,s);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const a=await r.json();return console.log("Upload thành công:",a),a}catch(n){throw console.error("Lỗi khi upload PDF:",n),n}}addSignature(t,i,e=null,n={}){const o={align:"right",fontSize:11,titleFontSize:10,nameFontSize:12,spacing:8,signatureHeight:20,blockWidth:100,...n},s=e||new Date().toLocaleDateString("vi-VN");let r;o.align==="right"?r=this.pageWidth-this.margins.right-o.blockWidth:o.align==="center"?r=(this.pageWidth-o.blockWidth)/2:r=this.margins.left;const a=r+o.blockWidth/2;this.doc.setFontSize(o.fontSize);try{this._setFont(null,"normal")}catch{this.doc.setFont("helvetica","normal")}this.doc.setTextColor(0,0,0);const l=this.doc.getTextWidth(s),c=a-l/2;this._drawText(s,c,this.currentY),this.currentY+=o.spacing,this.doc.setFontSize(o.titleFontSize);try{this._setFont(null,"bold")}catch{this.doc.setFont("helvetica","bold")}const d=this.doc.getTextWidth(i),h=a-d/2;this._drawText(i,h,this.currentY),this.currentY+=5;const g="(Ký và ghi rõ họ tên)";this.doc.setFontSize(9);try{this._setFont(null,"italic")}catch{this.doc.setFont("helvetica","italic")}this.doc.setTextColor(100,100,100);const u=this.doc.getTextWidth(g),f=a-u/2;this._drawText(g,f,this.currentY),this.currentY+=o.spacing,this.addSpace(o.signatureHeight),this.doc.setFontSize(o.nameFontSize);try{this._setFont(null,"bold")}catch{this.doc.setFont("helvetica","bold")}this.doc.setTextColor(0,0,0);const p=this.doc.getTextWidth(t),S=a-p/2;return this._drawText(t,S,this.currentY),this.currentY+=15,this}async loadImageFromPath(t){try{const i=await fetch(t);if(!i.ok)throw new Error(`Không thể load hình từ ${t}`);const e=await i.blob();return new Promise((n,o)=>{const s=new FileReader;s.onload=function(r){n(r.target.result)},s.onerror=function(r){o(new Error("Lỗi khi đọc file"))},s.readAsDataURL(e)})}catch(i){return console.warn(`Không thể load hình từ ${t}:`,i.message),null}}async addSignatureWithImage(t,i,e,n=null,o={}){const s={align:"right",fontSize:11,titleFontSize:10,nameFontSize:12,dateFontSize:10,spacing:8,imageWidth:60,imageHeight:20,blockWidth:100,...o},r=n||new Date().toLocaleDateString("vi-VN");let a;s.align==="right"?a=this.pageWidth-this.margins.right-s.blockWidth:s.align==="center"?a=(this.pageWidth-s.blockWidth)/2:a=this.margins.left;const l=a+s.blockWidth/2;this.doc.setFontSize(s.fontSize);try{this._setFont(null,"bold")}catch{this.doc.setFont("helvetica","bold")}this.doc.setTextColor(0,0,0),this.doc.setFontSize(s.dateFontSize);const c=this._decodeHtmlEntities(r),d=this.doc.getTextWidth(c),h=l-d/2;this._drawText(c,h,this.currentY),this.currentY+=s.spacing,this.doc.setFontSize(s.titleFontSize);try{this._setFont(null,"bold")}catch{this.doc.setFont("helvetica","bold")}const g=this._decodeHtmlEntities(i),u=this.doc.getTextWidth(g),f=l-u/2;this._drawText(g,f,this.currentY),this.currentY+=5;const p=s.noteText??"(Ký và ghi rõ họ tên)";this.doc.setFontSize(9);try{this._setFont(null,"italic")}catch{this.doc.setFont("helvetica","italic")}this.doc.setTextColor(100,100,100);const S=this._decodeHtmlEntities(p),m=this.doc.getTextWidth(S),y=l-m/2;this._drawText(S,y,this.currentY),this.currentY+=s.spacing,this.addSpace(5);let _=null;if(e&&(typeof e=="string"?e.startsWith("data:")?_=e:_=await this.loadImageFromPath(e):_=e),_){const z=l-s.imageWidth/2;this.addImage(_,z,this.currentY,s.imageWidth,s.imageHeight,{format:"JPEG"})}else if(s.nameTag&&s.nameTag.trim()){const z=this.doc.internal.getCurrentPageInfo().color||[0,0,0];this.doc.setTextColor(255,255,255),this.doc.setFontSize(9);try{this._setFont(null,"italic")}catch{this.doc.setFont("helvetica","italic")}const O=this._decodeHtmlEntities(s.nameTag),R=this.doc.getTextWidth(O),j=l-R/2;this._drawText(O,j,this.currentY+s.imageHeight/2),this.doc.setTextColor(z[0]||0,z[1]||0,z[2]||0),this.addSpace(s.imageHeight+10)}else this.addSpace(s.imageHeight+10);this.doc.setFontSize(s.nameFontSize);try{this._setFont(null,"bold")}catch{this.doc.setFont("helvetica","bold")}this.doc.setTextColor(0,0,0);const W=this._decodeHtmlEntities(t),F=this.doc.getTextWidth(W),M=l-F/2;return this._drawText(W,M,this.currentY),this.currentY+=15,this}async addSignatureFromFile(t,i,e,n=null,o={}){return await this.addSignatureWithImage(t,i,e,n,o)}async addSmartSignature(t,i,e={},n=null,o={}){const{imagePath:s=null,imageData:r=null,fallbackText:a=null,createFallback:l=!0}=e;let c=null;return s&&(c=await this.loadImageFromPath(s)),!c&&r&&(c=r),!c&&l&&(c=this.createTextSignature(a||t)),await this.addSignatureWithImage(t,i,c,n,o)}addSecondarySignature(t={}){const e={...{imageData:null,nameTag:"Secondary Signature",positions:["top-right"],width:15,height:15,margin:5,fontSize:8,showPageNumber:!1},...t},n=["top-left","top-right","bottom-left","bottom-right"],s=(Array.isArray(e.positions)?e.positions:[e.positions]).filter(a=>n.includes(a));if(s.length===0)return console.warn("No valid positions provided for secondary signature"),this;this.secondarySignatures||(this.secondarySignatures=[]),this.secondarySignatures.push({imageData:e.imageData,nameTag:e.nameTag,positions:s,width:e.width,height:e.height,margin:e.margin,fontSize:e.fontSize,showPageNumber:e.showPageNumber});const r=this.doc.internal.getNumberOfPages();for(let a=1;a<=r;a++)this.doc.setPage(a),this._renderSecondarySignature(e,a);return this}_renderSecondarySignature(t,i=null){const e=this.doc.internal.pageSize.width,n=this.doc.internal.pageSize.height;i===null&&(i=this.doc.internal.getCurrentPageInfo().pageNumber);for(const o of t.positions){let s,r;switch(o){case"top-left":s=t.margin,r=t.margin;break;case"top-right":s=e-t.width-t.margin,r=t.margin;break;case"bottom-left":s=t.margin,r=n-t.height-t.margin;break;case"bottom-right":s=e-t.width-t.margin,r=n-t.height-t.margin;break;default:continue}if(t.imageData)try{this.doc.addImage(t.imageData,"PNG",s,r,t.width,t.height)}catch(a){console.warn("Failed to add secondary signature image:",a),this._renderSecondarySignatureNameTag(s,r,t,i)}else this._renderSecondarySignatureNameTag(s,r,t,i)}}_renderSecondarySignatureNameTag(t,i,e,n){const o=this.doc.getTextColor(),s=this.doc.internal.getFontSize(),r=this.doc.getFont();this.doc.setTextColor(154,166,178),this.doc.setFontSize(e.fontSize);try{this._setFont(null,"italic")}catch{this.doc.setFont("helvetica","italic")}let a=e.nameTag;e.showPageNumber&&n&&(a=`${e.nameTag}_${n}`);const l=this._decodeHtmlEntities(a),c=this.doc.getTextWidth(l),d=t+(e.width-c),h=i+e.height/2+e.fontSize/2+3;this._drawText(l,d,h),this.doc.setTextColor(o),this.doc.setFontSize(s),this.doc.setFont(r.fontName,r.fontStyle)}_addSecondarySignaturesToNewPage(){if(this.secondarySignatures&&this.secondarySignatures.length>0)for(const t of this.secondarySignatures)this._renderSecondarySignature(t)}createTextSignature(t,i=120,e=40){const n=document.createElement("canvas"),o=n.getContext("2d");n.width=i,n.height=e,o.fillStyle="white",o.fillRect(0,0,i,e),o.fillStyle="#1a5490",o.font='italic bold 14px cursive, "Times New Roman", serif';const s=this._decodeHtmlEntities(t),r=o.measureText(s).width,a=(i-r)/2,l=e/2+5;return o.fillText(s,a,l),o.strokeStyle="#1a5490",o.lineWidth=1.5,o.beginPath(),o.moveTo(a-5,l+8),o.lineTo(a+r+5,l+8),o.stroke(),n.toDataURL("image/png")}addSimpleSignature(t,i,e=null,n={}){const o={fontSize:11,lineWidth:100,spacing:8,...n},s=e||this.margins.left;return this.addText(i,s,null,{fontSize:o.fontSize,fontStyle:"bold"}),this.addSpace(o.spacing),this.doc.setLineWidth(.5),this.doc.line(s,this.currentY,s+o.lineWidth,this.currentY),this.addSpace(5),this.addText(t,s,null,{fontSize:o.fontSize-1}),this.addSpace(15),this}addDualSignature(t,i){const n=this.margins.left,o=this.pageWidth/2+10,s=n+90/2,r=o+90/2,a=this.currentY;this.currentY=a;const l=t.date||"";this.renderCenteredText(l,s,this.currentY,11,"normal"),this.currentY+=8,this.renderCenteredText(t.title,s,this.currentY,10,"bold"),this.currentY+=5;const c=t.note||"(Ký và ghi rõ họ tên)";if(this.renderCenteredText(c,s,this.currentY,9,"italic",[100,100,100]),this.currentY+=25,t.signaturePath&&t.signaturePath.trim())try{this.doc.addImage(t.signaturePath,"PNG",s-15,this.currentY-20,30,15)}catch(u){console.warn("Không thể thêm chữ ký trái:",u)}else if(t.nameTag&&t.nameTag.trim()){const u=this.doc.internal.getCurrentPageInfo().color||[0,0,0];this.doc.setTextColor(255,255,255);const f=this._decodeHtmlEntities(t.nameTag);this._drawText(f,s-this.doc.getTextWidth(f)/2,this.currentY-15),this.doc.setTextColor(u[0]||0,u[1]||0,u[2]||0)}this.renderCenteredText(t.name,s,this.currentY,11,"bold");const d=this.currentY;this.currentY=a;const h=i.date||"";this.renderCenteredText(h,r,this.currentY,11,"normal"),this.currentY+=8,this.renderCenteredText(i.title,r,this.currentY,10,"bold"),this.currentY+=5;const g=i.note||"(Ký và ghi rõ họ tên)";if(this.renderCenteredText(g,r,this.currentY,9,"italic",[100,100,100]),this.currentY+=25,i.signaturePath&&i.signaturePath.trim())try{this.doc.addImage(i.signaturePath,"PNG",r-15,this.currentY-20,30,15)}catch(u){console.warn("Không thể thêm chữ ký phải:",u)}else if(i.nameTag&&i.nameTag.trim()){const u=this.doc.internal.getCurrentPageInfo().color||[0,0,0];this.doc.setTextColor(255,255,255);const f=this._decodeHtmlEntities(i.nameTag);this._drawText(f,r-this.doc.getTextWidth(f)/2,this.currentY-15),this.doc.setTextColor(u[0]||0,u[1]||0,u[2]||0)}return this.renderCenteredText(i.name,r,this.currentY,11,"bold"),this.currentY=Math.max(d,this.currentY)+10,this}renderCenteredText(t,i,e,n=11,o="normal",s=[0,0,0]){if(Array.isArray(t)){const r=this.currentY;this.currentY=e;let a=0;t.forEach(c=>{let d=typeof c=="string"?c:c.text;d=this._decodeHtmlEntities(d);const h=typeof c=="object"&&c.fontSize?c.fontSize:n,g=typeof c=="object"&&c.style?c.style:o;this.doc.setFontSize(h),this._setFont(null,g),a+=this.doc.getTextWidth(d)});let l=i-a/2;t.forEach(c=>{const d=typeof c=="string"?c:c.text,h=typeof c=="object"&&c.fontSize?c.fontSize:n,g=typeof c=="object"&&c.style?c.style:o,u=typeof c=="object"&&c.color?c.color:s;this.doc.setFontSize(h),this._setFont(null,g),this.doc.setTextColor(u[0],u[1],u[2]),this._drawText(d,l,e),l+=this.doc.getTextWidth(d)}),this.currentY=r}else if(typeof t=="object"&&t.text){const r=t.text,a=t.fontSize||n,l=t.style||o,c=t.color||s;this.doc.setFontSize(a),this._setFont(null,l),this.doc.setTextColor(c[0],c[1],c[2]);const d=this._decodeHtmlEntities(r),h=this.doc.getTextWidth(d);this._drawText(d,i-h/2,e)}else{let r=t.toString();r=this._decodeHtmlEntities(r),this.doc.setFontSize(n),this._setFont(null,o),this.doc.setTextColor(s[0],s[1],s[2]);const a=this.doc.getTextWidth(r);this._drawText(r,i-a/2,e)}}addLeaderDots(t,i,e={}){t=this._decodeHtmlEntities(t),i=this._decodeHtmlEntities(i);const n={fontSize:11,fontStyle:"normal",color:[0,0,0],dotChar:".",dotSpacing:3,minDots:3,leftPadding:5,rightPadding:5,lineHeight:6,...e};this.doc.setFontSize(n.fontSize),this._setFont(null,n.fontStyle);const o=Array.isArray(n.color)?n.color:[0,0,0];this.doc.setTextColor(...o);const s=this.doc.getTextWidth(t),r=this.doc.getTextWidth(i),a=this.doc.getTextWidth(n.dotChar),l=this.margins.left,c=this.pageWidth-this.margins.right-r,d=l+s+n.leftPadding,h=c-n.rightPadding,g=h-d,u=Math.max(n.minDots,Math.floor(g/(a+n.dotSpacing)));this.checkPageBreak(n.lineHeight+3),this._drawText(t,l,this.currentY);let f=d;for(let p=0;p<u;p++)f+a<=h&&(this._drawText(n.dotChar,f,this.currentY),f+=a+n.dotSpacing);return this._drawText(i,c,this.currentY),this.currentY+=n.lineHeight,this}addTableOfContents(t,i={}){const e={title:"MỤC LỤC",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},itemOptions:{fontSize:11,fontStyle:"normal",indent:0},subItemOptions:{fontSize:10,fontStyle:"normal",indent:15},...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),t.forEach(n=>{let o=typeof n=="string"?n:n.title;o=this._decodeHtmlEntities(o);const s=typeof n=="object"?n.page:"",a=typeof n=="object"&&n.isSubItem?e.subItemOptions:e.itemOptions,l=a.indent||0,c=" ".repeat(l/3)+o;this.addLeaderDots(c,s.toString(),{...a,leftPadding:5,rightPadding:5})}),this}addPriceList(t,i={}){const e={title:"BẢNG GIÁ",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},itemOptions:{fontSize:11,fontStyle:"normal"},currency:"VNĐ",...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),t.forEach(n=>{const o=n.name||n.title,s=n.price||n.cost||0,r=this._decodeHtmlEntities(o),a=this.formatPrice(s,e.currency),l=this._decodeHtmlEntities(a);this.addLeaderDots(r,l,{...e.itemOptions,leftPadding:8,rightPadding:8})}),this}addMenu(t,i={}){const e={title:"THỰC ĐƠN",titleOptions:{fontSize:18,fontStyle:"bold",align:"center",color:[139,0,0]},sectionOptions:{fontSize:14,fontStyle:"bold",color:[0,0,139]},itemOptions:{fontSize:11,fontStyle:"normal"},currency:"VNĐ",...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(15)),t.forEach(n=>{this.addText(n.name,null,null,e.sectionOptions),this.addSpace(8),n.items.forEach(o=>{const s=`${o.name}${o.description?` - ${o.description}`:""}`,r=this.formatPrice(o.price,e.currency),a=this._decodeHtmlEntities(s),l=this._decodeHtmlEntities(r);this.addLeaderDots(a,l,{...e.itemOptions,leftPadding:10,rightPadding:10,dotChar:".",dotSpacing:2})}),this.addSpace(12)}),this}addIndex(t,i={}){const e={title:"CHỈ MỤC",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},itemOptions:{fontSize:10,fontStyle:"normal"},columns:2,...i};if(e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),e.columns===1)t.forEach(n=>{const o=this._decodeHtmlEntities(n.term),s=this._decodeHtmlEntities(n.pages.join(", "));this.addLeaderDots(o,s,{...e.itemOptions,leftPadding:5,rightPadding:5,lineHeight:5})});else{const n=Math.ceil(t.length/e.columns),o=(this.pageWidth-this.margins.left-this.margins.right)/e.columns;for(let s=0;s<e.columns;s++){const r=s*n,a=Math.min(r+n,t.length),l=t.slice(r,a),c=this.currentY,d=this.margins.left+s*o;s>0&&(this.currentY=c),l.forEach(h=>{const g=this._decodeHtmlEntities(h.term),u=this._decodeHtmlEntities(h.pages.join(", ")),f=this.doc.getTextWidth(g),p=this.doc.getTextWidth(u);this.doc.setFontSize(e.itemOptions.fontSize);const S=this.doc.getTextWidth("."),m=o-f-p-15,y=Math.max(3,Math.floor(m/(S+2)));this._drawText(g,d,this.currentY);let _=d+f+5;for(let F=0;F<y;F++)this._drawText(".",_,this.currentY),_+=S+2;const W=d+o-p-5;this._drawText(u,W,this.currentY),this.currentY+=5})}}return this}formatPrice(t,i="VNĐ"){return typeof t=="number"?t.toLocaleString("vi-VN")+" "+i:t.toString()+" "+i}addFillInLine(t="",i={}){t=this._decodeHtmlEntities(t);const e={lineCount:1,lineLength:100,lineSpacing:8,lineStyle:"dots",lineWidth:.5,lineColor:[0,0,0],dotSpacing:1,dotChar:".",labelPosition:"left",labelOptions:{fontSize:11,fontStyle:"normal",color:[0,0,0],spacing:5},align:"left",showPlaceholder:!1,placeholderText:"(điền thông tin)",placeholderOptions:{fontSize:9,fontStyle:"italic",color:[150,150,150]}},n={...e,...i,labelOptions:{...e.labelOptions,...i.labelOptions||{}},placeholderOptions:{...e.placeholderOptions,...i.placeholderOptions||{}}};let o;if(this.currentY,n.align==="center"?o=(this.pageWidth-n.lineLength)/2:n.align==="right"?o=this.pageWidth-this.margins.right-n.lineLength:o=this.margins.left,t&&n.labelPosition!=="none"){this.doc.setFontSize(n.labelOptions.fontSize),this._setFont(null,n.labelOptions.fontStyle);const a=Array.isArray(n.labelOptions.color)?n.labelOptions.color:[0,0,0];this.doc.setTextColor(...a);const l=this.doc.getTextWidth(t);if(n.labelPosition==="above"){const c=n.align==="center"?(this.pageWidth-l)/2:n.align==="right"?this.pageWidth-this.margins.right-l:this.margins.left;this._drawText(t,c,this.currentY),this.currentY+=n.labelOptions.spacing}else n.labelPosition==="left"&&(this._drawText(t,this.margins.left,this.currentY),o=this.margins.left+l+n.labelOptions.spacing,n.lineLength=Math.min(n.lineLength,this.pageWidth-this.margins.right-o))}const s=(n.lineCount-1)*n.lineSpacing+10;this.checkPageBreak(s),this.doc.setLineWidth(n.lineWidth);const r=Array.isArray(n.lineColor)?n.lineColor:[0,0,0];this.doc.setDrawColor(...r);for(let a=0;a<n.lineCount;a++){const l=this.currentY+a*n.lineSpacing;if(n.lineStyle==="dots"){this.doc.setFontSize(n.labelOptions.fontSize);try{this._setFont(null,"normal")}catch{this.doc.setFont("helvetica","normal")}const c=Array.isArray(n.lineColor)?n.lineColor:[0,0,0];this.doc.setTextColor(...c);const d=this.doc.getTextWidth(n.dotChar),h=Math.floor(n.lineLength/(d+n.dotSpacing));for(let g=0;g<h;g++){const u=o+g*(d+n.dotSpacing);u+d<=o+n.lineLength&&this._drawText(n.dotChar,u,l)}}else n.lineStyle==="dashed"?this.doc.setLineDashPattern([3,2],0):n.lineStyle==="dotted"?this.doc.setLineDashPattern([1,2],0):this.doc.setLineDashPattern([],0),this.doc.line(o,l,o+n.lineLength,l);if(n.showPlaceholder&&n.placeholderText){this.doc.setFontSize(n.placeholderOptions.fontSize),this._setFont(null,n.placeholderOptions.fontStyle);const c=Array.isArray(n.placeholderOptions.color)?n.placeholderOptions.color:[150,150,150];this.doc.setTextColor(...c);const d=l-2;this._drawText(n.placeholderText,o+5,d)}}if(this.doc.setLineDashPattern([],0),t&&n.labelPosition==="right"){this.doc.setFontSize(n.labelOptions.fontSize),this._setFont(null,n.labelOptions.fontStyle);const a=Array.isArray(n.labelOptions.color)?n.labelOptions.color:[0,0,0];this.doc.setTextColor(...a);const l=o+n.lineLength+n.labelOptions.spacing;this._drawText(t,l,this.currentY)}if(t&&n.labelPosition==="below"){const a=this.currentY+(n.lineCount-1)*n.lineSpacing;this.currentY=a+n.labelOptions.spacing;const l=this.doc.getTextWidth(t),c=n.align==="center"?(this.pageWidth-l)/2:n.align==="right"?this.pageWidth-this.margins.right-l:this.margins.left;this._drawText(t,c,this.currentY)}return this.currentY+=(n.lineCount-1)*n.lineSpacing+10,this}addFillInForm(t,i={}){const e={title:null,titleOptions:{fontSize:14,fontStyle:"bold",color:[0,0,0]},fieldSpacing:12,columns:1,...i};if(e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(8)),e.columns===1)t.forEach(n=>{const o={lineLength:150,labelPosition:"left",...n.options};this.addFillInLine(n.label||"",o),this.addSpace(e.fieldSpacing-10)});else{const n=Math.ceil(t.length/e.columns),o=(this.pageWidth-this.margins.left-this.margins.right)/e.columns;for(let s=0;s<t.length;s+=n){const r=t.slice(s,s+n),a=Math.floor(s/n),l=this.currentY;r.forEach((c,d)=>{a>0&&(this.currentY=l+d*e.fieldSpacing);const h={lineLength:o-20,labelPosition:"above",align:"left",...c.options},g=this.margins.left+a*o,u=this.margins.left;this.margins.left=g,this.addFillInLine(c.label||"",h),this.margins.left=u,a===0&&this.addSpace(e.fieldSpacing-10)})}}return this}addSignatureFillIn(t=[],i={}){const e={layout:"horizontal",signatureWidth:120,dateWidth:80,spacing:20,showDate:!0,dateLabel:"Ngày:",signatureLabel:"Chữ ký:",nameLabel:"Họ tên:",...i};if(e.layout==="horizontal"){const n=t.length*(e.signatureWidth+e.spacing)-e.spacing;let o=(this.pageWidth-n)/2;t.forEach((s,r)=>{const a=o+r*(e.signatureWidth+e.spacing),l=this.margins.left;this.margins.left=a,e.showDate&&this.addFillInLine(e.dateLabel,{lineLength:e.dateWidth,labelPosition:"left",align:"left"}),s.title&&this.addText(s.title,a+(e.signatureWidth-this.doc.getTextWidth(s.title))/2,null,{fontSize:10,fontStyle:"bold"}),this.addFillInLine(e.signatureLabel,{lineLength:e.signatureWidth,labelPosition:"above",align:"left"}),this.addFillInLine(e.nameLabel,{lineLength:e.signatureWidth,labelPosition:"left",align:"left"}),this.margins.left=l})}else t.forEach(n=>{n.title&&this.addText(n.title,null,null,{fontSize:12,fontStyle:"bold",align:"center"}),e.showDate&&this.addFillInLine(e.dateLabel,{lineLength:e.dateWidth,labelPosition:"left",align:"center"}),this.addFillInLine(e.signatureLabel,{lineLength:e.signatureWidth,labelPosition:"above",align:"center"}),this.addFillInLine(e.nameLabel,{lineLength:e.signatureWidth,labelPosition:"left",align:"center"}),this.addSpace(e.spacing)});return this}addDottedFillIn(t="",i={}){const e={lineStyle:"dots",dotChar:".",dotSpacing:2,lineLength:100,labelPosition:"left",...i};return this.addFillInLine(t,e)}addDottedForm(t,i={}){const e={fieldDefaults:{lineStyle:"dots",dotChar:".",dotSpacing:2},...i},n=t.map(o=>({...o,options:{...e.fieldDefaults,...o.options}}));return this.addFillInForm(n,e)}addDottedSignature(t=[],i={}){const e={lineStyle:"dots",dotChar:".",dotSpacing:2,...i},n=this.addFillInLine.bind(this);this.addFillInLine=(s,r={})=>n(s,{lineStyle:"dots",dotChar:".",dotSpacing:2,...r});const o=this.addSignatureFillIn(t,e);return this.addFillInLine=n,o}addCustomDottedLine(t="",i=".",e=2,n=100,o={}){return this.addFillInLine(t,{lineStyle:"dots",dotChar:i,dotSpacing:e,lineLength:n,...o})}addMixedText(t,i={}){const n={...{fontSize:12,color:[0,0,0],maxWidth:this.pageWidth-this.margins.left-this.margins.right,align:"left",lineHeight:this.lineHeight},...i};n.lineHeight=parseFloat(n.lineHeight)||5,n.fontSize=parseFloat(n.fontSize)||12,n.maxWidth=parseFloat(n.maxWidth)||this.pageWidth-this.margins.left-this.margins.right;let o=n.x||this.margins.left,s=this.currentY,r=[],a=0;return this.checkPageBreak(n.lineHeight+10),s=this.currentY,t.forEach((l,c)=>{let d=typeof l=="string"?l:l.text;d=this._decodeHtmlEntities(d);let h="normal";if(typeof l=="object"&&l.style){if(typeof l.style=="string")h=l.style;else if(typeof l.style=="object"){const p=l.style;p.bold&&p.italic?h="bolditalic":p.bold?h="bold":p.italic?h="italic":h="normal"}}const g=typeof l=="object"&&l.color?l.color:typeof l=="object"&&l.style&&l.style.color?l.style.color:n.color;let u=typeof l=="object"&&l.fontSize?l.fontSize:typeof l=="object"&&l.style&&l.style.fontSize?l.style.fontSize:n.fontSize;if(u=parseFloat(u)||n.fontSize||12,this.doc.setFontSize(u),this._setFont(null,h),!d)return;const f=String(d).split(" ");f.forEach((p,S)=>{const m=S<f.length-1?p+" ":p,y=this.doc.getTextWidth(m);if(a+y>n.maxWidth&&r.length>0){this.renderMixedLine(r,o,s,n,!1),s+=n.lineHeight;const F=this.currentY;this.checkPageBreak(n.lineHeight+5),this.currentY<F&&(s=this.currentY),o=n.x||this.margins.left,r=[],a=0}const _=typeof l=="object"&&l.style&&typeof l.style=="object"?l.style.underline:!1,W=typeof l=="object"&&l.style&&typeof l.style=="object"?l.style.strikethrough:!1;r.push({text:m,style:h,color:this._parseColorToArray(g),fontSize:u,width:y,underline:_,strikethrough:W}),a+=y})}),r.length>0&&(this.renderMixedLine(r,o,s,n,!0),s+=n.lineHeight),n.spacing!==void 0&&n.spacing,this.currentY=s,this}renderMixedLine(t,i,e,n,o=!1){if(!t||t.length===0)return;let s=i;if(n.align==="center"){const r=t.reduce((a,l)=>a+l.width,0);s=(this.pageWidth-r)/2}else if(n.align==="right"){const r=t.reduce((a,l)=>a+l.width,0);s=this.pageWidth-this.margins.right-r}else if(n.align==="justify"&&!o&&t.length>1){this.renderJustifiedMixedLine(t,i,e,n);return}t.forEach(r=>{if(this.doc.setFontSize(r.fontSize),this._setFont(null,r.style),this.doc.setTextColor(r.color[0],r.color[1],r.color[2]),this._drawText(r.text,s,e),r.underline){const a=this.doc.getTextWidth(r.text.trimEnd()),l=e+1;this.doc.setDrawColor(r.color[0],r.color[1],r.color[2]),this.doc.setLineWidth(.3),this.doc.line(s,l,s+a,l)}if(r.strikethrough){const a=this.doc.getTextWidth(r.text.trimEnd()),l=e-r.fontSize*.12;this.doc.setDrawColor(r.color[0],r.color[1],r.color[2]),this.doc.setLineWidth(.3),this.doc.line(s,l,s+a,l)}s+=r.width})}renderJustifiedMixedLine(t,i,e,n){if(t.length<=1){this.renderMixedLine(t,i,e,{...n,align:"left"});return}let o=0;t.forEach(c=>{this.doc.setFontSize(c.fontSize),this._setFont(null,c.style),o+=this.doc.getTextWidth(c.text.trimEnd())});const s=t.length-1,a=(n.maxWidth-o)/s;let l=i;t.forEach((c,d)=>{this.doc.setFontSize(c.fontSize),this._setFont(null,c.style),this.doc.setTextColor(c.color[0],c.color[1],c.color[2]);const h=c.text.trimEnd(),g=this.doc.getTextWidth(h);if(this._drawText(h,l,e),c.underline){const u=e+1;this.doc.setDrawColor(c.color[0],c.color[1],c.color[2]),this.doc.setLineWidth(.3),this.doc.line(l,u,l+g,u)}if(c.strikethrough){const u=e-c.fontSize*.12;this.doc.setDrawColor(c.color[0],c.color[1],c.color[2]),this.doc.setLineWidth(.3),this.doc.line(l,u,l+g,u)}l+=g,d<t.length-1&&(l+=a)})}addMixedParagraph(t,i={}){const e={fontSize:10,color:[0,0,0],lineHeight:5,align:"left",maxWidth:this.pageWidth-this.margins.left-this.margins.right,spacing:1,...i};return!Array.isArray(t)||t.length===0?(console.warn("addMixedParagraph: textParts phải là array không rỗng"),this):(this.addMixedText(t,e),this.currentY+=e.spacing,this)}createTextPart(t,i="normal",e=null,n=null){const o={text:t,style:i};return e&&(o.color=Array.isArray(e)?e:[0,0,0]),n&&(o.fontSize=n),o}bold(t,i=null,e=null){return this.createTextPart(t,"bold",i,e)}italic(t,i=null,e=null){return this.createTextPart(t,"italic",i,e)}boldItalic(t,i=null,e=null){return this.createTextPart(t,"bolditalic",i,e)}normal(t,i=null,e=null){return this.createTextPart(t,"normal",i,e)}colored(t,i,e="normal",n=null){return this.createTextPart(t,e,i,n)}addStyledParagraph(t,i={}){return Array.isArray(t)||(t=[t]),this.addMixedParagraph(t,i)}addNumberedText(t,i={}){t=this._decodeHtmlEntities(t);const e={fontSize:11,fontStyle:"normal",color:[0,0,0],numberStyle:"decimal",numberFormat:"{number}.",startNumber:1,indent:20,numberWidth:15,lineHeight:null,maxWidth:null,align:"left",showIndex:!0,lineSpacing:1.3,...i};e.lineHeight===null&&(e.lineHeight=Math.max(this.lineHeight,Math.ceil(e.fontSize*e.lineSpacing))),e.maxWidth||(e.maxWidth=this.pageWidth-this.margins.left-this.margins.right-e.indent),this.currentNumberByStyle||(this.currentNumberByStyle={}),this.currentNumberByStyle[e.numberStyle]||(this.currentNumberByStyle[e.numberStyle]=e.startNumber);const n=this.currentNumberByStyle[e.numberStyle];let o="";switch(e.numberStyle){case"decimal":o=n.toString();break;case"roman":o=this.toRomanNumeral(n);break;case"alpha":o=this.toAlphaNumeral(n);break;case"bullet":o="•";break;default:o=n.toString()}const s=e.numberFormat.replace("{number}",o);this.doc.setFontSize(e.fontSize),this._setFont(null,e.fontStyle);const r=Array.isArray(e.color)?e.color:[0,0,0];this.doc.setTextColor(...r);const a=this.doc.splitTextToSize(t,e.maxWidth);if(e.skipPageBreakCheck!==!0){const h=a.length*(3+e.lineHeight);this.checkPageBreak(h+10)}let l=this.margins.left,c=this.margins.left+e.indent,d=this.currentY;return a.forEach((h,g)=>{if(a.length>5&&e.skipPageBreakCheck!==!0&&(this.checkPageBreak(3+e.lineHeight+5),d=this.currentY),g===0&&e.showIndex){if(e.align==="center"){const u=this.doc.getTextWidth(s+" "+h),f=(this.pageWidth-u)/2;l=f,c=f+this.doc.getTextWidth(s)+5}else if(e.align==="right"){const u=this.doc.getTextWidth(s+" "+h),f=this.pageWidth-this.margins.right-u;l=f,c=f+this.doc.getTextWidth(s)+5}else l=this.margins.left,c=this.margins.left+e.indent;this._drawText(s,l,d)}if(e.align==="center")if(g===0&&e.showIndex)this._drawText(h,c,d);else{const u=this.doc.getTextWidth(h),f=(this.pageWidth-u)/2;this._drawText(h,f,d)}else if(e.align==="right")if(g===0&&e.showIndex)this._drawText(h,c,d);else{const u=this.doc.getTextWidth(h),f=this.pageWidth-this.margins.right-u;this._drawText(h,f,d)}else if(e.align==="justify"){const u=g===a.length-1;g===0?(c=this.margins.left+e.indent,!u&&h.trim().length>0?this.drawJustifiedText(h,c,d,e.maxWidth,e):this._drawText(h,c,d)):(c=this.margins.left+e.indent,!u&&h.trim().length>0?this.drawJustifiedText(h,c,d,e.maxWidth,e):this._drawText(h,c,d))}else g===0?c=this.margins.left+e.indent:c=this.margins.left+e.indent,this._drawText(h,c,d);d+=3+e.lineHeight}),this.currentY=d,this.currentNumberByStyle[e.numberStyle]++,this}resetNumbering(t="decimal",i=1){return this.currentNumberByStyle||(this.currentNumberByStyle={}),this.currentNumberByStyle[t]=i,this}addNumberedList(t,i={}){const e={title:null,titleOptions:{fontSize:14,fontStyle:"bold",color:[0,0,0],align:"left"},itemOptions:{fontSize:11,fontStyle:"normal",color:[0,0,0],numberStyle:"decimal",indent:20,align:"left"},spacing:.5,resetNumbers:!0,...i};return e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(5)),e.resetNumbers&&this.resetNumbering(e.itemOptions.numberStyle,1),t.forEach((n,o)=>{const s=typeof n=="string"?n:n.text,r=typeof n=="object"?{...e.itemOptions,...n.options}:e.itemOptions;this.doc.setFontSize(r.fontSize||11);const a=r.maxWidth||this.pageWidth-this.margins.left-this.margins.right-(r.indent||20),c=this.doc.splitTextToSize(s,a).length*((r.lineHeight||this.lineHeight)+3)+(e.spacing||.5)+10;this.checkPageBreak(c);const d={...r,skipPageBreakCheck:!0};this.addNumberedText(s,d),o<t.length-1&&this.addSpace(e.spacing)}),this}addMultiLevelList(t,i={}){const e={level1:{numberStyle:"decimal",numberFormat:"{number}.",indent:20,fontSize:11},level2:{numberStyle:"alpha",numberFormat:"{number})",indent:35,fontSize:10},level3:{numberStyle:"roman",numberFormat:"({number})",indent:50,fontSize:10},level4:{numberStyle:"bullet",numberFormat:"{number}",indent:65,fontSize:9},spacing:2,...i};this.resetNumbering("decimal",1),this.resetNumbering("alpha",1),this.resetNumbering("roman",1);const n=(o,s=1)=>{const r=`level${Math.min(s,4)}`,a=e[r];o.forEach((l,c)=>{if(typeof l=="string")this.addNumberedText(l,a);else if(l.text){const d={...a,...l.options};this.addNumberedText(l.text,d),l.subItems&&Array.isArray(l.subItems)&&(this.addSpace(e.spacing),n(l.subItems,s+1))}c<o.length-1&&this.addSpace(e.spacing)})};return n(t),this}toRomanNumeral(t){const i=[["M",1e3],["CM",900],["D",500],["CD",400],["C",100],["XC",90],["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]];let e="";for(let[n,o]of i){const s=Math.floor(t/o);e+=n.repeat(s),t-=o*s}return e.toLowerCase()}toAlphaNumeral(t){let i="";for(;t>0;)t--,i=String.fromCharCode(97+t%26)+i,t=Math.floor(t/26);return i}addOutline(t,i={}){const e={title:"OUTLINE",titleOptions:{fontSize:16,fontStyle:"bold",align:"center"},h1Options:{numberStyle:"decimal",numberFormat:"{number}.",fontSize:12,fontStyle:"bold",indent:15},h2Options:{numberStyle:"decimal",numberFormat:"{number}.{parent}.",fontSize:11,fontStyle:"normal",indent:25},h3Options:{numberStyle:"decimal",numberFormat:"{number}.{parent}.{grandparent}.",fontSize:10,fontStyle:"normal",indent:35},showPageNumbers:!0,...i};e.title&&(this.addText(e.title,null,null,e.titleOptions),this.addSpace(10)),this.resetNumbering("h1",1),this.resetNumbering("h2",1),this.resetNumbering("h3",1);const n=(o,s=1,r=[])=>{o.forEach(a=>{const l=typeof a=="string"?a:a.title,c=typeof a=="object"?a.page:"",d=typeof a=="object"?a.subItems:null;let h=`h${Math.min(s,3)}`,g=e[`${h}Options`],u=this.currentNumberByStyle[h]||1,f=u.toString();g.numberFormat.includes("{parent}")&&r.length>0&&(f=f+"."+r[r.length-1]),g.numberFormat.includes("{grandparent}")&&r.length>1&&(f=f+"."+r[r.length-2]);const p=g.numberFormat.replace("{number}",u).replace("{parent}",r[r.length-1]||"").replace("{grandparent}",r[r.length-2]||"");if(e.showPageNumbers&&c?this.addLeaderDots(p+" "+l,c.toString(),{fontSize:g.fontSize,fontStyle:g.fontStyle,leftPadding:g.indent}):this.addText(p+" "+l,this.margins.left+g.indent,null,{fontSize:g.fontSize,fontStyle:g.fontStyle}),this.currentNumberByStyle||(this.currentNumberByStyle={}),this.currentNumberByStyle[h]=u+1,d&&Array.isArray(d)){const S=[...r,u];this.resetNumbering(`h${s+1}`,1),n(d,s+1,S)}})};return n(t),this}getPageInfo(){return{currentPage:this.doc.internal.getCurrentPageInfo().pageNumber,totalPages:this.doc.internal.getNumberOfPages(),pageSize:this.doc.internal.pageSize,currentY:this.currentY}}alignColons(t,i=1){const e=t.map(s=>{const[r,a]=s.split(":");return{left:r??"",right:a??""}}),n=Math.max(...e.map(s=>s.left.trimEnd().length)),o=" ".repeat(i);return e.map(s=>{const r=" ".repeat(n-s.left.trimEnd().length);return`${s.left.trimEnd()}${r} :${o}${s.right.trimStart()}`})}}class k{constructor(t={}){this.options={...t},this.fontConfig={...E,...t.fonts,...t},this.pdfService=null,this.margins=t.margins||{left:15,right:15,top:20,bottom:20},this.pageWidth=210,this.contentWidth=this.pageWidth-this.margins.left-this.margins.right}calculateX(t){const i=t.indent||0,e=t.marginLeft||0;return this.margins.left+i+e}render(t,i={}){return this.pdfService=new L(this.options),t.margins&&(this.margins={...this.margins,...t.margins},this.contentWidth=this.pageWidth-this.margins.left-this.margins.right),t.pages.forEach((e,n)=>{n>0&&this.pdfService.addNewPage(),this.pdfService.resetPosition(this.margins.top),this.renderPage(e,i)}),this}cleanContent(t){if(!t)return"";let i=String(t);return i=i.replace(/<br\s*\/?>/gi,`
`),i=i.replace(/<\/p>\s*<p[^>]*>/gi,`
`),i=i.replace(/<[^>]*>/g,""),this.pdfService._decodeHtmlEntities(i)}renderPage(t,i){t.elements.forEach(e=>{switch(e.content&&(e.content=this.pdfService._decodeHtmlEntities(e.content)),e.type){case"text":this.renderText(e,i);break;case"richtext":this.renderRichText(e,i);break;case"heading":this.renderHeading(e,i);break;case"table":this.renderTable(e,i);break;case"image":this.renderImage(e,i);break;case"line":this.renderLine(e);break;case"space":this.pdfService.addSpace(e.height||10);break;case"evalblock":this.renderEvalBlock(e,i);break;case"codeblock":this.renderCodeBlock(e,i);break}})}renderRichText(t,i){const e=t.segments||[],n=t.style||{},o=e.map(h=>({text:this.replaceVariables(h.text,i),style:h.style})),s=this.calculateX(t),r=n.lineHeight||5,a={fontSize:n.fontSize||12,color:this.parseColor(n.color),align:n.align||"left",lineHeight:r,x:s,maxWidth:t.width||this.contentWidth};if(!o.some(h=>h.text&&(h.text.includes("___BR___")||h.text.includes("___HR___")||h.text.includes("___PAGEBREAK___")))){const h=o.map(g=>({...g,text:g.text?g.text.replace(/___TAB___/g,"    "):g.text}));this.pdfService.addMixedParagraph(h,a);return}let c=o.map(h=>h.text||"").join("");c=c.replace(/___TAB___/g,"    ");const d=c.split(/(___BR___|___HR___|___PAGEBREAK___)/);for(const h of d)if(h==="___BR___")this.pdfService.addSpace(this.pdfService.lineHeight);else if(h==="___HR___")this.pdfService.addHorizontalLine();else if(h==="___PAGEBREAK___")this.pdfService.addNewPage();else if(h.trim()){const g=[{text:h.trim(),style:{}}];this.pdfService.addMixedParagraph(g,a)}}renderText(t,i){let e=this.replaceVariables(t.content,i);const n=t.style||{},o=n.lineHeight||5,s={fontSize:n.fontSize||12,fontStyle:this.mapFontStyle(n),color:this.parseColor(n.color),align:n.align||"left",lineHeight:o},r=this.calculateX(t);if(e=e.replace(/___TAB___/g,"    "),!e.includes("___BR___")&&!e.includes("___HR___")&&!e.includes("___PAGEBREAK___")){this.pdfService.addText(e,r,null,s);return}const a=e.split(/(___BR___|___HR___|___PAGEBREAK___)/);for(const l of a)l==="___BR___"?this.pdfService.addSpace(o):l==="___HR___"?this.pdfService.addHorizontalLine():l==="___PAGEBREAK___"?this.pdfService.addNewPage():l.trim()&&this.pdfService.addText(l.trim(),r,null,s)}renderHeading(t,i){var o,s,r;const e=this.replaceVariables(t.content,i);switch(t.level||1){case 1:this.pdfService.addTitle(e,{align:((o=t.style)==null?void 0:o.align)||"center"});break;case 2:this.pdfService.addSubTitle(e,{align:((s=t.style)==null?void 0:s.align)||"left"});break;default:this.pdfService.addText(e,null,null,{fontSize:14,fontStyle:"bold",align:((r=t.style)==null?void 0:r.align)||"left"})}}renderTable(t,i){var g,u;const e=t.rows||[];if(e.length===0)return;if(t.dataVar){const f=t.dataVar.replace(/\{\{|\}\}/g,""),p=i[f];if(Array.isArray(p)){this.renderDataTable(t,p);return}}t.y!==void 0&&this.pdfService.resetPosition(t.y);const n=[],o=t.style||{},s=(f,p,S)=>{if(!f)return{content:""};const m=f.cellStyle||{},y={halign:f.align||"left",valign:m.verticalAlign==="top"?"top":m.verticalAlign==="bottom"?"bottom":"middle"};if(m.backgroundColor&&(y.fillColor=this.parseColorToArray(m.backgroundColor)),m.borderColor&&(y.lineColor=this.parseColorToArray(m.borderColor)),m.borderWidth&&(y.lineWidth=m.borderWidth),m.padding&&(y.cellPadding=m.padding),f.type==="image")return n.push({rowIndex:p,cellIndex:S,src:f.src,width:f.width,height:f.height}),{content:"[IMG]",colSpan:f.colSpan||1,rowSpan:f.rowSpan||1,styles:y};const _=typeof f=="object"?this.replaceVariables(f.content,i):f;return{content:this.cleanContent(_),colSpan:f.colSpan||1,rowSpan:f.rowSpan||1,styles:y}};let r=0;for(let f=0;f<e.length&&e[f].some(S=>S.isHeader);f++)r++;r===0&&e.length>0&&(r=1);const a=e.slice(0,r).map((f,p)=>f.map((S,m)=>s(S,p,m))),l=(g=e[0])==null?void 0:g[0],c=(u=l==null?void 0:l.cellStyle)==null?void 0:u.backgroundColor,d=e.slice(r).map((f,p)=>f.map((S,m)=>s(S,p+r,m))),h={tableWidth:t.width};o.borderWidth!==void 0&&(h.lineWidth=o.borderWidth),o.borderColor&&(h.lineColor=this.parseColorToArray(o.borderColor)),o.backgroundColor&&(h.fillColor=this.parseColorToArray(o.backgroundColor)),o.align==="center"?h.tableAlign="center":o.align==="right"&&(h.tableAlign="right"),c&&(h.headStyles={fillColor:this.parseColorToArray(c)}),typeof this.pdfService.addTable=="function"?this.pdfService.addTable(a,d,h):this.drawTableManually(t,i)}parseColorToArray(t){if(!t)return[0,0,0];if(t.startsWith("#")){const e=t.slice(1),n=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),s=parseInt(e.substr(4,2),16);return[n,o,s]}const i=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return i?[parseInt(i[1]),parseInt(i[2]),parseInt(i[3])]:[0,0,0]}renderDataTable(t,i){const e=t.columns||[];if(e.length===0||!Array.isArray(i))return;const n=e.map(s=>s.label||s),o=i.map(s=>e.map(r=>{const a=r.key||r;return String(s[a]||"")}));typeof this.pdfService.addTable=="function"&&this.pdfService.addTable(n,o,t.style||{})}drawTableManually(t,i){var d;const e=t.rows||[],n=t.x||this.pdfService.margins.left,o=t.width||this.pdfService.pageWidth-n-this.pdfService.margins.right,s=t.rowHeight||8,r=((d=e[0])==null?void 0:d.length)||1,a=o/r,l=this.pdfService.doc;let c=this.pdfService.getCurrentY();l.setLineWidth(.5),l.setFontSize(10),e.forEach((h,g)=>{h.forEach((u,f)=>{const p=n+f*a,S=typeof u=="object"?this.replaceVariables(u.content,i):this.replaceVariables(String(u),i),m=typeof u=="object"?u.isHeader:g===0;m&&(l.setFillColor(240,240,240),l.rect(p,c,a,s,"F")),l.setDrawColor(0,0,0),l.rect(p,c,a,s);try{l.setFont(this.fontConfig.defaultFont,m?"bold":"normal")}catch{l.setFont(this.fontConfig.fallback||"helvetica",m?"bold":"normal")}l.setTextColor(0,0,0);const y=S.replace(/<[^>]*>/g,""),_=c+s/2+2;l.text(y,p+2,_,{maxWidth:a-4})}),c+=s}),this.pdfService.resetPosition(c+5)}renderImage(t,i){let e=this.replaceVariables(t.src,i);if(e&&(e.startsWith("data:")||e.startsWith("http"))){const n=t.x!==void 0?t.x:this.margins.left;this.pdfService.addImage(e,n,null,t.width||50,t.height||50,t.style||{})}}renderLine(t){if(t.fullWidth){const i=this.pdfService.getCurrentY();this.pdfService.addLine(this.margins.left,i,this.pageWidth-this.margins.right,i,t.style||{}),this.pdfService.addSpace(5)}else this.pdfService.addLine(t.x1,t.y1,t.x2,t.y2,t.style||{})}replaceVariables(t,i){return P.process(t,i)}processLayoutMarkers(t,i={}){if(!t||typeof t!="string")return t||"";let e=t.replace(/___TAB___/g,"    ");const n=e.includes("___BR___"),o=e.includes("___HR___"),s=e.includes("___PAGEBREAK___");if(!n&&!o&&!s)return e;const r=e.split(/(___BR___|___HR___|___PAGEBREAK___)/);for(let a=0;a<r.length;a++){const l=r[a];l==="___BR___"?this.pdfService.addSpace(i.lineHeight||5):l==="___HR___"?this.pdfService.addHorizontalLine():l==="___PAGEBREAK___"?this.pdfService.addNewPage():l.trim()}return e.replace(/___BR___|___HR___|___PAGEBREAK___/g,"")}hasLayoutMarkers(t){return t?t.includes("___BR___")||t.includes("___HR___")||t.includes("___PAGEBREAK___"):!1}renderTextWithMarkers(t,i={}){if(!t)return;const n=t.replace(/___TAB___/g,"    ").split(/(___BR___|___HR___|___PAGEBREAK___)/),o=i.x||this.margins.left,s=i.fontSize||12,r=i.lineHeight||s*.5;for(const a of n)a==="___BR___"?this.pdfService.addSpace(r):a==="___HR___"?this.pdfService.addHorizontalLine?this.pdfService.addHorizontalLine():this.pdfService.addSpace(5):a==="___PAGEBREAK___"?this.pdfService.addNewPage():a.trim()&&this.pdfService.addText(a.trim(),o,null,{fontSize:s,maxWidth:i.maxWidth||this.contentWidth,align:i.align||"left",color:i.color})}mapFontStyle(t){return t.fontWeight==="bold"&&t.fontStyle==="italic"?"bolditalic":t.fontWeight==="bold"?"bold":t.fontStyle==="italic"?"italic":"normal"}parseColor(t){if(!t)return[0,0,0];if(Array.isArray(t))return t;if(typeof t=="string"&&t.startsWith("#")){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(i)return[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16)]}if(typeof t=="string"&&t.startsWith("rgb")){const i=t.match(/(\d+),\s*(\d+),\s*(\d+)/);if(i)return[parseInt(i[1]),parseInt(i[2]),parseInt(i[3])]}return[0,0,0]}getDataUrl(){return this.pdfService.generateDataURL()}download(t="document.pdf"){this.pdfService.savePDF(t)}getBlob(){return this.pdfService.generateBlob()}preview(){this.pdfService.previewPDF()}renderEvalBlock(t,i){let e=t.code||"";e=e.replace(/^\/\/\s*eval\s*/i,""),e=e.replace(/^\/\*\s*eval\s*\*\/\s*/i,""),console.log("[PDFRenderer] Evaluating code block with full PDF access...");try{const n={pdf:this.pdfService,data:i,renderer:this,formatNumber:r=>P.formatNumber(r),formatCurrency:r=>P.formatCurrency(r),formatDate:r=>P.formatDate(r),today:()=>P.formatDateObject(new Date),now:()=>new Date().toLocaleString("vi-VN"),year:()=>new Date().getFullYear(),sum:(r,a)=>Array.isArray(r)?r.reduce((l,c)=>l+(Number(c[a])||0),0):0,count:r=>Array.isArray(r)?r.length:0,filter:(r,a)=>Array.isArray(r)?r.filter(a):[],map:(r,a)=>Array.isArray(r)?r.map(a):[],join:(r,a=", ")=>Array.isArray(r)?r.join(a):"",addText:(r,a,l,c)=>this.pdfService.addText(r,a,l,c),addTitle:(r,a)=>this.pdfService.addTitle(r,a),addTable:(r,a,l)=>this.pdfService.addTable(r,a,l),addSpace:r=>this.pdfService.addSpace(r),addLine:()=>this.pdfService.addHorizontalLine(),addImage:(r,a,l,c,d)=>this.pdfService.addImage(r,a,l,c,d),newPage:()=>this.pdfService.addNewPage(),addHeader:(r,a)=>this.pdfService.addHeader(r,a),addFooter:(r,a)=>this.pdfService.addFooter(r,a),addPageNumbers:r=>this.pdfService.addFooter(r.format||"{pageNumber}",r),addFilter:(r,a)=>this.pdfService.addFillInLine(r,a),addFiller:(r,a)=>this.pdfService.addFillInLine(r,a),addSign:(r,a)=>this.pdfService.addDottedSignature(r,a),addSignature:(r,a)=>this.pdfService.addSignatureFillIn(r,a),addDualSignature:(...r)=>this.pdfService.addDualSignature(...r),addSimpleSignature:(...r)=>this.pdfService.addSimpleSignature(...r),addSecondarySignature:(...r)=>this.pdfService.addSecondarySignature(...r),addSmartSignature:(...r)=>this.pdfService.addSmartSignature(...r),addSignatureFromFile:(...r)=>this.pdfService.addSignatureFromFile(...r),addSignatureWithImage:(...r)=>this.pdfService.addSignatureWithImage(...r),addSignature:(...r)=>this.pdfService.addSignatureFillIn(...r)},s=new Function(...Object.keys(n),`
        "use strict";
        ${e}
      `)(...Object.values(n));console.log("[PDFRenderer] Eval completed, result:",s),typeof s=="string"&&s.trim()&&this.pdfService.addText(s,this.margins.left,null,{fontSize:12,maxWidth:this.contentWidth})}catch(n){console.error("[PDFRenderer] Eval error:",n),this.pdfService.addText(`[Eval Error: ${n.message}]`,this.margins.left,null,{fontSize:10,color:[255,0,0]})}}renderCodeBlock(t,i){const e=t.code||"",n=t.language||"text";console.log("[PDFRenderer] Rendering code block:",n,e.length,"chars"),this.pdfService.addText(e,this.margins.left,null,{fontSize:10,fontStyle:"normal",maxWidth:this.contentWidth})}}const H=class H{constructor(){this.editor=null,this.parser=new N,this.renderer=null,this.blueprint=null,this._initialized=!1,this.fontConfig={...E}}async init(t,i={}){var f,p,S,m;const e=typeof t=="string"?document.querySelector(t):t;if(!e)throw new Error(`DrawPDF: Element not found: ${t}`);const n=window.CKEDITOR??((f=window.DrawPDF)==null?void 0:f.CKEDITOR),o=(n==null?void 0:n.DecoupledEditor)||(n==null?void 0:n.ClassicEditor)||window.DecoupledEditor||window.ClassicEditor;if(!o)throw new Error("DrawPDF: CKEditor not loaded. Please include CKEditor script before using DrawPDF.");const s={toolbar:{items:["undo","redo","|","findAndReplace","|","heading","|","bold","italic","underline","strikethrough","subscript","superscript","code","removeFormat","|","fontFamily","fontSize","fontColor","fontBackgroundColor","highlight","|","alignment","|","bulletedList","numberedList","todoList","|","outdent","indent","|","link","uploadImage","insertTable","blockQuote","codeBlock","|","horizontalLine","pageBreak","specialCharacters"],shouldNotGroupWhenFull:!0},heading:{options:[{model:"paragraph",title:"Paragraph",class:"ck-heading_paragraph"},{model:"heading1",view:"h1",title:"Heading 1"},{model:"heading2",view:"h2",title:"Heading 2"},{model:"heading3",view:"h3",title:"Heading 3"},{model:"heading4",view:"h4",title:"Heading 4"},{model:"heading5",view:"h5",title:"Heading 5"},{model:"heading6",view:"h6",title:"Heading 6"}]},fontSize:{options:[12,13,14,16,18,20,22,24,26,28,32,36,42,48,72],supportAllValues:!0},fontFamily:{options:["default","Roboto, sans-serif","Times New Roman, Times, serif","Arial, Helvetica, sans-serif","Georgia, serif","Verdana, Geneva, sans-serif","Courier New, Courier, monospace","Tahoma, Geneva, sans-serif","Trebuchet MS, sans-serif"],supportAllValues:!0},fontColor:{colors:[{color:"#000000",label:"Black"},{color:"#4d4d4d",label:"Dark Gray"},{color:"#999999",label:"Gray"},{color:"#e6e6e6",label:"Light Gray"},{color:"#ffffff",label:"White"},{color:"#e64c4c",label:"Red"},{color:"#e6994c",label:"Orange"},{color:"#e6e64c",label:"Yellow"},{color:"#4ce64c",label:"Green"},{color:"#4c4ce6",label:"Blue"},{color:"#994ce6",label:"Purple"}]},table:{contentToolbar:["tableColumn","tableRow","mergeTableCells","tableProperties","tableCellProperties"]},image:{toolbar:["imageTextAlternative","toggleImageCaption","imageStyle:inline","imageStyle:block","imageStyle:side","linkImage"]},link:{addTargetToExternalLinks:!0,defaultProtocol:"https://"},placeholder:`Soạn thảo văn bản ở đây...

Sử dụng {{tênBiến}} để chèn biến.`,language:"vi",removePlugins:["CKBox","CKFinder","EasyImage","RealTimeCollaborativeComments","RealTimeCollaborativeTrackChanges","RealTimeCollaborativeRevisionHistory","PresenceList","Comments","TrackChanges","TrackChangesData","RevisionHistory","Pagination","WProofreader","MathType","SlashCommand","Template","DocumentOutline","FormatPainter","TableOfContents","PasteFromOfficeEnhanced","CaseChange","AIAssistant","AI","MultiLevelList","RestrictedEditingMode","StandardEditingMode"]},{fonts:r,format:a,orientation:l,margins:c,unit:d,...h}=i,g={...s,...h};r&&(this.fontConfig={...E,...r}),this.fontConfig.register&&this.fontConfig.register.length>0&&await this._loadFontFiles(this.fontConfig.register);const u={...this.fontConfig,fonts:this.fontConfig,...i};this.renderer=new k(u);try{if(this.editor=await o.create(e,g),(m=(S=(p=this.editor.ui)==null?void 0:p.view)==null?void 0:S.toolbar)!=null&&m.element)if(i.toolbarContainer){const y=typeof i.toolbarContainer=="string"?document.querySelector(i.toolbarContainer):i.toolbarContainer;y&&y.appendChild(this.editor.ui.view.toolbar.element)}else e instanceof HTMLElement&&e.parentNode&&(this._toolbarElement=this.editor.ui.view.toolbar.element,e.parentNode.insertBefore(this._toolbarElement,e));this._initialized=!0,console.log("✅ DrawPDF initialized with font:",this.fontConfig.defaultFont)}catch(y){throw console.error("DrawPDF init failed:",y),y}return this}async _loadFontFiles(t){for(const i of t)try{await this._loadFontScript(i),console.log(`✅ Font loaded: ${i}`)}catch(e){console.warn(`⚠️ Failed to load font: ${i}`,e.message)}}_loadFontScript(t){return new Promise((i,e)=>{const n=document.createElement("script");n.src=t,n.onload=i,n.onerror=()=>e(new Error(`Failed to load font script: ${t}`)),document.head.appendChild(n)})}async registerFont(t){return await this._loadFontScript(t),console.log(`✅ Font registered: ${t}`),this}getData(){if(!this._initialized)throw new Error("DrawPDF: Not initialized. Call init() first.");const t=this.editor.getData();return this.blueprint=this.parser.parse(t),this.blueprint.sourceHtml=t,this.blueprint.createdAt=new Date().toISOString(),this.blueprint}setData(t){if(!t||typeof t!="object")throw new Error("DrawPDF: setData expects a JSON Blueprint object.");return this.blueprint=t,this._initialized&&t.sourceHtml&&this.editor.setData(t.sourceHtml),this}render(t={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint. Call getData() or setData() first.");return this.renderer.render(this.blueprint,t),this.renderer.getDataUrl()}download(t="document.pdf",i={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint. Call getData() or setData() first.");return this.renderer.render(this.blueprint,i),this.renderer.download(t),this}getBlob(t={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint.");return this.renderer.render(this.blueprint,t),this.renderer.getBlob()}preview(t={}){if(!this.blueprint&&this._initialized&&this.getData(),!this.blueprint)throw new Error("DrawPDF: No blueprint.");this.renderer.render(this.blueprint,t),this.renderer.preview()}getBlueprint(){return this.blueprint}exportJson(){if(!this.blueprint)throw new Error("DrawPDF: No blueprint to export.");return JSON.stringify(this.blueprint,null,2)}importJson(t){const i=JSON.parse(t);return this.setData(i)}destroy(){this.editor&&(this._toolbarElement&&this._toolbarElement.parentNode&&this._toolbarElement.parentNode.removeChild(this._toolbarElement),this._toolbarElement=null,this.editor.destroy(),this.editor=null,this._initialized=!1),this.blueprint=null}static async create(t,i={}){const e=new H;return await e.init(t,i),e}static parseHtml(t){const e=new N().parse(t);return e.sourceHtml=t,e.createdAt=new Date().toISOString(),e}static renderBlueprint(t,i={}){const e=new k;return e.render(t,i),e.getDataUrl()}static downloadBlueprint(t,i="document.pdf",e={}){const n=new k;n.render(t,e),n.download(i)}};Y(H,"JsPdfService",L);let I=H;const B="2.1.0";b.CKEditorParser=N,b.DrawPDF=I,b.FONTS=C,b.FONT_CONFIG=E,b.JsPdfService=L,b.PAGE=T,b.PDFRenderer=k,b.RichTextTokenizer=A,b.TemplateEngine=P,b.VERSION=B,b.default=I,Object.defineProperties(b,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
